<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="theme-color" content="#667eea" id="themeColorMeta">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
  <title>LinguaVox ‚Äî –ì–æ–ª–æ—Å–æ–≤–æ–π –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫</title>
  <style>
    /* ===================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –¢–ï–ú ===================== */
    :root {
      --bg:           #0f0f1a;
      --bg2:          #1a1a2e;
      --bg3:          #0d0d17;
      --card:         #1e1e35;
      --border:       #2a2a4a;
      --text:         #e8e8f0;
      --text2:        #a0a0b8;
      --text3:        #666680;
      --accent1:      #667eea;
      --accent2:      #764ba2;
      --accent-rgb:   102, 126, 234;
      --danger:       #ff4d4d;
      --danger-rgb:   255, 77, 77;
      --success:      #00b894;
      --warn-bg:      rgba(255,170,0,0.10);
      --warn-border:  rgba(255,170,0,0.35);
      --warn-text:    #ffaa44;
      --err-bg:       rgba(255,77,77,0.10);
      --err-border:   rgba(255,77,77,0.35);
      --err-text:     #ff8888;
      --shadow:       0 4px 24px rgba(0,0,0,0.4);
      --radius:       16px;
      --radius-sm:    10px;
    }
    [data-theme="light"] {
      --bg:           #f0f2f8;
      --bg2:          #e4e8f4;
      --bg3:          #dde2f0;
      --card:         #ffffff;
      --border:       #d0d8ee;
      --text:         #1e2140;
      --text2:        #5a6080;
      --text3:        #9098b8;
      --accent1:      #0984e3;
      --accent2:      #4a90d9;
      --accent-rgb:   9, 132, 227;
      --danger:       #e53935;
      --danger-rgb:   229, 57, 53;
      --success:      #00897b;
      --warn-bg:      rgba(255,152,0,0.10);
      --warn-border:  rgba(255,152,0,0.35);
      --warn-text:    #e67e00;
      --err-bg:       rgba(229,57,53,0.10);
      --err-border:   rgba(229,57,53,0.35);
      --err-text:     #e53935;
      --shadow:       0 4px 24px rgba(0,0,0,0.10);
    }

    /* ===================== –°–ë–†–û–° –ò –ë–ê–ó–ê ===================== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh; display: flex; flex-direction: column;
      align-items: center; padding: 0 0 40px;
      transition: background 0.3s, color 0.3s;
    }

    /* ===================== –®–ê–ü–ö–ê ===================== */
    header {
      width: 100%; background: var(--bg2);
      border-bottom: 1px solid var(--border);
      padding: 14px 20px; display: flex; align-items: center;
      justify-content: space-between;
      position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow);
    }
    .header-title { display: flex; flex-direction: column; }
    .header-title h1 {
      font-size: 1.15rem; font-weight: 700;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; line-height: 1.2;
    }
    .header-title span { font-size: 0.7rem; color: var(--text3); margin-top: 2px; }
    .theme-btn {
      width: 40px; height: 40px; border-radius: 50%;
      border: 1px solid var(--border); background: var(--card);
      color: var(--text2); font-size: 1.1rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.25s; flex-shrink: 0;
    }
    .theme-btn:hover { background: var(--border); }

    /* ===================== –ö–û–ù–¢–ï–ù–¢ ===================== */
    .content {
      width: 100%; max-width: 480px;
      padding: 20px 16px 0; display: flex;
      flex-direction: column; gap: 14px;
    }

    /* ===================== –í–ö–õ–ê–î–ö–ò ===================== */
    .tabs {
      display: flex; background: var(--bg2);
      border-radius: var(--radius); padding: 4px; gap: 4px;
      border: 1px solid var(--border);
    }
    .tab {
      flex: 1; padding: 11px 8px; border: none;
      background: transparent; color: var(--text2);
      border-radius: var(--radius-sm); cursor: pointer;
      font-size: 0.82rem; font-weight: 500;
      transition: all 0.25s; line-height: 1.3; text-align: center;
    }
    .tab.active {
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: #fff; font-weight: 600;
      box-shadow: 0 2px 12px rgba(var(--accent-rgb), 0.4);
    }

    /* ===================== –ö–ê–†–¢–û–ß–ö–ê ===================== */
    .card {
      background: var(--card); border-radius: var(--radius);
      border: 1px solid var(--border); padding: 20px;
      box-shadow: var(--shadow); transition: background 0.3s, border-color 0.3s;
    }
    .card-label {
      font-size: 0.68rem; font-weight: 700; letter-spacing: 1.2px;
      text-transform: uppercase; color: var(--text3); margin-bottom: 14px;
    }

    /* ===================== –í–´–ë–û–† –Ø–ó–´–ö–ê ===================== */
    .lang-pills { display: flex; flex-wrap: wrap; gap: 8px; }
    .lang-pill {
      padding: 8px 16px; border: 2px solid var(--border);
      background: transparent; color: var(--text2); border-radius: 30px;
      cursor: pointer; font-size: 0.82rem; font-weight: 500; transition: all 0.25s;
    }
    .lang-pill.active {
      border-color: var(--accent1); color: var(--accent1);
      background: rgba(var(--accent-rgb), 0.1);
    }

    /* ===================== –ë–õ–û–ö –ó–ê–ü–ò–°–ò ===================== */
    .record-wrap {
      display: flex; flex-direction: column;
      align-items: center; gap: 14px; padding: 10px 0 4px;
    }
    .mic-btn {
      width: 90px; height: 90px; border-radius: 50%; border: none;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: #fff; font-size: 2rem; cursor: pointer;
      box-shadow: 0 6px 28px rgba(var(--accent-rgb), 0.5);
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex; align-items: center; justify-content: center;
      position: relative; -webkit-tap-highlight-color: transparent;
    }
    .mic-btn:active { transform: scale(0.94); }
    .mic-btn.recording {
      background: linear-gradient(135deg, var(--danger), #cc0000);
      box-shadow: 0 6px 28px rgba(var(--danger-rgb), 0.55);
      animation: mic-pulse 1.4s infinite;
    }
    .mic-btn.busy { opacity: 0.5; cursor: not-allowed; }
    @keyframes mic-pulse {
      0%   { box-shadow: 0 6px 28px rgba(var(--danger-rgb), 0.55); }
      50%  { box-shadow: 0 6px 44px rgba(var(--danger-rgb), 0.85), 0 0 0 14px rgba(var(--danger-rgb), 0.10); }
      100% { box-shadow: 0 6px 28px rgba(var(--danger-rgb), 0.55); }
    }
    .record-hint { font-size: 0.82rem; color: var(--text3); text-align: center; }
    .record-hint.live { color: var(--danger); font-weight: 600; }

    /* ===================== –¢–ï–ö–°–¢–û–í–´–ô –í–í–û–î ===================== */
    .text-input-row { display: flex; gap: 8px; margin-top: 4px; }
    .text-input {
      flex: 1; background: var(--bg2); border: 1px solid var(--border);
      border-radius: var(--radius-sm); color: var(--text);
      font-size: 0.9rem; padding: 10px 14px; outline: none;
      transition: border-color 0.25s;
    }
    .text-input:focus { border-color: var(--accent1); }
    .text-input::placeholder { color: var(--text3); }
    .send-btn {
      width: 42px; height: 42px; border-radius: var(--radius-sm);
      border: none; background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: #fff; font-size: 1.1rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; transition: opacity 0.2s;
    }
    .send-btn:active { opacity: 0.8; }

    /* ===================== TTS –°–ö–û–†–û–°–¢–¨ ===================== */
    .controls-row { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
    .controls-label { font-size: 0.7rem; color: var(--text3); }
    .speed-btn {
      width: 30px; height: 30px; border-radius: 50%;
      border: 1px solid var(--border); background: transparent;
      cursor: pointer; font-size: 0.85rem;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; -webkit-tap-highlight-color: transparent;
    }
    .speed-btn.active { background: rgba(var(--accent-rgb), 0.15); border-color: var(--accent1); }

    /* ===================== –†–ê–°–ü–û–ó–ù–ê–ù–û ===================== */
    .recognized-box {
      background: var(--bg2); border: 1px solid var(--border);
      border-radius: var(--radius-sm); padding: 12px 14px;
      font-size: 0.95rem; color: var(--text);
      line-height: 1.6; min-height: 50px; word-break: break-word;
    }
    .recognized-box.empty { color: var(--text3); font-style: italic; }

    /* ===================== –°–û–û–ë–©–ï–ù–ò–Ø ===================== */
    .msg {
      border-radius: var(--radius-sm); padding: 11px 14px;
      font-size: 0.82rem; line-height: 1.5; display: none;
    }
    .msg.warn { background: var(--warn-bg); border: 1px solid var(--warn-border); color: var(--warn-text); }
    .msg.err  { background: var(--err-bg);  border: 1px solid var(--err-border);  color: var(--err-text); }
    .msg.visible { display: block; }

    /* ===================== –ü–ï–†–ï–í–û–î–´ ===================== */
    .translations { display: flex; flex-direction: column; gap: 12px; }
    .tr-card {
      background: var(--bg2); border: 1px solid var(--border);
      border-radius: var(--radius-sm); padding: 14px; transition: border-color 0.3s;
    }
    .tr-card:hover { border-color: var(--accent1); }
    .tr-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .tr-lang { display: flex; align-items: center; gap: 7px; }
    .tr-flag { font-size: 1.25rem; }
    .tr-name {
      font-size: 0.68rem; font-weight: 700;
      letter-spacing: 1px; text-transform: uppercase; color: var(--text3);
    }
    .tr-text {
      font-size: 1rem; color: var(--text);
      line-height: 1.65; min-height: 38px; word-break: break-word;
    }
    .tr-text[dir="rtl"] {
      font-size: 1.08rem;
      font-family: 'Noto Naskh Arabic', 'Segoe UI', 'Arial', sans-serif;
      text-align: right;
      direction: rtl;
    }
    .tr-text.loading { color: var(--text3); font-style: italic; animation: blink 1.2s infinite; }
    .tr-text.err-text { color: var(--err-text); font-style: italic; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .tr-actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .tr-btn {
      padding: 6px 14px; border-radius: 20px; cursor: pointer;
      font-size: 0.78rem; font-weight: 500; transition: all 0.2s; border: none;
    }
    .play-btn {
      background: rgba(var(--accent-rgb), 0.15);
      border: 1px solid rgba(var(--accent-rgb), 0.35); color: var(--accent1);
    }
    .play-btn:hover { background: rgba(var(--accent-rgb), 0.28); }
    .play-btn.playing { background: rgba(var(--accent-rgb), 0.28); animation: button-pulse 1s infinite; }
    @keyframes button-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.65; } }
    .show-btn { background: transparent; border: 1px solid var(--border); color: var(--text2); }
    .show-btn:hover { background: var(--bg3); }
    .copy-btn { background: transparent; border: 1px solid var(--border); color: var(--text2); }
    .copy-btn:hover { background: var(--bg3); }
    .copy-btn.copied { color: var(--success); border-color: var(--success); }
    .share-btn { background: transparent; border: 1px solid var(--border); color: var(--text2); }
    .share-btn:hover { background: var(--bg3); }
    .tr-translit {
      font-size: 0.78rem; color: var(--text3); font-style: italic;
      margin: 2px 0 6px; letter-spacing: 0.3px; min-height: 0;
    }

    /* ===================== RESULTS HEADER ===================== */
    .results-head {
      display: flex; align-items: center;
      justify-content: space-between; margin-bottom: 14px;
    }
    .results-head .card-label { margin-bottom: 0; }
    .icon-btn {
      width: 30px; height: 30px; border-radius: 50%;
      border: 1px solid var(--border); background: transparent;
      color: var(--text2); font-size: 0.85rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; flex-shrink: 0;
    }
    .icon-btn:hover { background: var(--border); }

    /* ===================== –§–†–ê–ó–û–í–ù–ò–ö ===================== */
    .collapsible-head {
      display: flex; align-items: center; justify-content: space-between;
      cursor: pointer; user-select: none;
    }
    .collapsible-head .card-label { margin-bottom: 0; }
    .toggle-icon { font-size: 0.65rem; color: var(--text3); transition: transform 0.25s; }
    .toggle-icon.open { transform: rotate(180deg); }

    /* ===================== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –Ø–ó–´–ö–û–í ===================== */
    .lang-modal-overlay {
      position: fixed; inset: 0; z-index: 500;
      background: rgba(0,0,0,0.55); display: none;
      align-items: flex-end; justify-content: center;
    }
    .lang-modal-overlay.open { display: flex; }
    .lang-modal {
      width: 100%; max-width: 480px; background: var(--card);
      border-radius: var(--radius) var(--radius) 0 0;
      border: 1px solid var(--border); padding: 20px 16px 32px;
      max-height: 70vh; overflow-y: auto;
    }
    .lang-modal-title {
      font-size: 0.72rem; font-weight: 700; letter-spacing: 1.2px;
      text-transform: uppercase; color: var(--text3); margin-bottom: 14px;
    }
    .lang-modal-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;
    }
    .lang-modal-item {
      padding: 10px 14px; border: 1px solid var(--border);
      border-radius: var(--radius-sm); cursor: pointer;
      font-size: 0.85rem; background: transparent; color: var(--text);
      text-align: left; transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .lang-modal-item:hover, .lang-modal-item:active { border-color: var(--accent1); background: rgba(var(--accent-rgb), 0.08); }

    /* ===================== –ò–°–¢–û–†–ò–Ø ===================== */
    .history-body { margin-top: 12px; }
    .history-list { display: flex; flex-direction: column; gap: 6px; }
    .history-item {
      display: flex; align-items: center; gap: 8px;
      padding: 9px 12px; border: 1px solid var(--border);
      border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .history-item:hover { border-color: var(--accent1); background: rgba(var(--accent-rgb), 0.05); }
    .history-flag { font-size: 0.9rem; flex-shrink: 0; }
    .history-text {
      font-size: 0.85rem; color: var(--text); flex: 1;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .history-ts { font-size: 0.68rem; color: var(--text3); flex-shrink: 0; }
    .history-langs { font-size: 0.78rem; flex-shrink: 0; opacity: 0.6; }
    .history-empty {
      text-align: center; color: var(--text3);
      font-size: 0.82rem; padding: 16px 0; font-style: italic;
    }
    .history-clear-btn {
      margin-top: 8px; width: 100%; padding: 8px;
      border: 1px solid var(--border); background: transparent;
      color: var(--text3); border-radius: var(--radius-sm);
      cursor: pointer; font-size: 0.72rem; transition: all 0.2s;
    }
    .history-clear-btn:hover { color: var(--danger); border-color: var(--danger); }
    .history-del {
      flex-shrink: 0; width: 22px; height: 22px; border-radius: 50%;
      border: none; background: transparent; color: var(--text3);
      font-size: 0.75rem; cursor: pointer; display: flex;
      align-items: center; justify-content: center;
      transition: all 0.2s; -webkit-tap-highlight-color: transparent;
    }
    .history-del:hover { color: var(--danger); background: rgba(var(--danger-rgb), 0.12); }

    /* ===================== FULLSCREEN ===================== */
    .fs-overlay {
      position: fixed; inset: 0; z-index: 9999;
      background: #000; display: none;
      flex-direction: column; align-items: center;
      justify-content: center; padding: 30px 24px;
    }
    .fs-lang { font-size: 1rem; color: rgba(255,255,255,0.4); margin-bottom: 28px; letter-spacing: 1px; }
    .fs-text {
      font-size: clamp(2.4rem, 12vw, 4.5rem);
      color: #fff; text-align: center; line-height: 1.45;
      word-break: break-word;
      font-family: 'Noto Naskh Arabic', 'Segoe UI', 'Arial', sans-serif;
      max-width: 100%;
    }
    .fs-close {
      margin-top: 50px; padding: 13px 36px;
      border: 2px solid rgba(255,255,255,0.2); background: transparent;
      color: rgba(255,255,255,0.8); border-radius: 40px;
      font-size: 1rem; cursor: pointer; transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .fs-close:active, .fs-close:hover { background: rgba(255,255,255,0.12); }

    /* ===================== WORD COUNTER ===================== */
    .word-counter { font-size: 0.65rem; color: var(--text3); margin-top: 2px; transition: color 0.3s; }
    .word-counter.warn   { color: var(--warn-text); }
    .word-counter.danger { color: var(--danger); }

    /* ===================== –§–£–¢–ï–† ===================== */
    footer {
      text-align: center; color: var(--text3);
      font-size: 0.68rem; padding: 20px 16px 0; line-height: 1.8;
    }

    /* ===================== –ö–ù–û–ü–ö–ê SWAP ===================== */
    .swap-btn {
      width: 40px; height: 40px; border-radius: 50%;
      border: 1px solid var(--border); background: var(--card);
      color: var(--text2); font-size: 1.1rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.25s; flex-shrink: 0;
    }
    .swap-btn:hover { background: var(--border); }

    /* ===================== –°–¢–ò–õ–¨ –ü–ï–†–ï–í–û–î–ê (—Ç–æ–Ω) ===================== */
    .tone-btn {
      padding: 4px 10px; border-radius: 20px;
      border: 1px solid var(--border); background: transparent;
      font-size: 0.7rem; cursor: pointer; color: var(--text2);
      transition: all 0.2s; -webkit-tap-highlight-color: transparent;
    }
    .tone-btn.active { background: rgba(var(--accent-rgb),0.15); border-color: var(--accent1); color: var(--accent1); }

    /* ===================== –ì–†–û–ú–ö–û–°–¢–¨ ===================== */
    .volume-slider {
      -webkit-appearance: none; flex: 1; height: 4px;
      border-radius: 2px; background: var(--border); cursor: pointer; outline: none;
    }
    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 16px; height: 16px;
      border-radius: 50%; background: var(--accent1); cursor: pointer;
    }

    /* ===================== –ö–û–ù–¢–ï–ö–°–¢ –°–ò–¢–£–ê–¶–ò–ò ===================== */
    .context-input {
      width: 100%; background: var(--bg2); border: 1px solid var(--border);
      border-radius: var(--radius-sm); color: var(--text);
      font-size: 0.78rem; padding: 8px 12px; outline: none;
      transition: border-color 0.25s; margin-top: 8px;
    }
    .context-input:focus { border-color: var(--accent1); }
    .context-input::placeholder { color: var(--text3); }

    /* ===================== –†–ï–î–ê–ö–¢–ò–†–£–ï–ú–´–ô –¢–ï–ö–°–¢ ===================== */
    .recognized-box[contenteditable="true"]:focus { outline: 1px solid var(--accent1); border-radius: var(--radius-sm); }
    .retranslate-btn {
      margin-top: 8px; padding: 6px 16px;
      border: 1px solid var(--accent1); background: rgba(var(--accent-rgb),0.1);
      color: var(--accent1); border-radius: 20px; font-size: 0.78rem;
      cursor: pointer; display: none; transition: all 0.2s;
    }
    .retranslate-btn.show { display: inline-flex; align-items: center; gap: 4px; }

    /* ===================== –ò–ó–ë–†–ê–ù–ù–û–ï ===================== */
    .fav-btn {
      background: transparent; border: 1px solid var(--border);
      color: var(--text3); border-radius: 20px; padding: 6px 10px;
      cursor: pointer; font-size: 0.78rem; transition: all 0.2s;
    }
    .fav-btn.starred { color: #f39c12; border-color: #f39c12; background: rgba(243,156,18,0.1); }
    .fav-section { margin-top: 10px; }
    .fav-section-title {
      font-size: 0.68rem; font-weight: 700; letter-spacing: 1.2px;
      text-transform: uppercase; color: var(--text3); margin-bottom: 6px;
    }
    .fav-item {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 12px; border: 1px solid var(--border);
      border-radius: var(--radius-sm); margin-bottom: 4px;
      cursor: pointer; transition: all 0.2s; font-size: 0.83rem;
    }
    .fav-item:hover { border-color: #f39c12; background: rgba(243,156,18,0.05); }
    .fav-item-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .fav-item-del {
      flex-shrink: 0; width: 22px; height: 22px; border-radius: 50%;
      border: none; background: transparent; color: var(--text3);
      font-size: 0.75rem; cursor: pointer; display: flex;
      align-items: center; justify-content: center; transition: all 0.2s;
    }
    .fav-item-del:hover { color: var(--danger); background: rgba(var(--danger-rgb),0.12); }

    /* ===================== –§–†–ê–ó–û–í–ù–ò–ö ===================== */
    .phrase-categories { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; margin-top: 12px; }
    .phrase-cat-btn {
      padding: 6px 12px; border: 1px solid var(--border);
      background: transparent; color: var(--text2);
      border-radius: 20px; font-size: 0.75rem; cursor: pointer;
      transition: all 0.2s; -webkit-tap-highlight-color: transparent;
    }
    .phrase-cat-btn.active { border-color: var(--accent1); color: var(--accent1); background: rgba(var(--accent-rgb),0.1); }
    .phrase-list { display: flex; flex-direction: column; gap: 4px; }
    .phrase-item {
      padding: 9px 14px; border: 1px solid var(--border);
      background: var(--bg2); border-radius: var(--radius-sm);
      font-size: 0.85rem; color: var(--text); cursor: pointer;
      transition: all 0.2s; text-align: left; width: 100%;
      -webkit-tap-highlight-color: transparent;
    }
    .phrase-item:hover, .phrase-item:active { border-color: var(--accent1); background: rgba(var(--accent-rgb),0.08); }

    /* ===================== –ß–ê–¢ (–î–ò–ê–õ–û–ì) ===================== */
    .chat-view { display: flex; flex-direction: column; gap: 8px; max-height: 340px; overflow-y: auto; padding: 4px 0; }
    .chat-bubble {
      max-width: 85%; padding: 10px 14px;
      border-radius: 18px; font-size: 0.88rem; line-height: 1.5;
    }
    .chat-bubble.user {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: #fff; border-bottom-right-radius: 4px;
    }
    .chat-bubble.partner {
      align-self: flex-start;
      background: var(--bg2); border: 1px solid var(--border);
      color: var(--text); border-bottom-left-radius: 4px;
    }
    .chat-bubble-lang { font-size: 0.62rem; opacity: 0.7; margin-bottom: 3px; }
    .chat-bubble-text { word-break: break-word; }
    .chat-bubble-translit { font-size: 0.7rem; opacity: 0.7; font-style: italic; margin-top: 3px; }
    .chat-clear-btn {
      align-self: center; margin-top: 4px; padding: 5px 14px;
      border: 1px solid var(--border); background: transparent;
      color: var(--text3); border-radius: 20px; font-size: 0.7rem;
      cursor: pointer; transition: all 0.2s;
    }
    .chat-clear-btn:hover { color: var(--danger); border-color: var(--danger); }

    /* ===================== –û–ù–ë–û–†–î–ò–ù–ì ===================== */
    .onboard-overlay {
      position: fixed; inset: 0; z-index: 10000;
      background: rgba(0,0,0,0.75); display: flex;
      align-items: center; justify-content: center; padding: 20px;
    }
    .onboard-overlay.hidden { display: none; }
    .onboard-modal {
      width: 100%; max-width: 360px; background: var(--card);
      border-radius: var(--radius); border: 1px solid var(--border);
      padding: 28px 24px; text-align: center;
    }
    .onboard-icon { font-size: 3rem; margin-bottom: 12px; }
    .onboard-title { font-size: 1.05rem; font-weight: 700; color: var(--text); margin-bottom: 8px; }
    .onboard-text { font-size: 0.83rem; color: var(--text2); line-height: 1.65; margin-bottom: 20px; }
    .onboard-dots { display: flex; justify-content: center; gap: 7px; margin-bottom: 18px; }
    .onboard-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); transition: background 0.2s; }
    .onboard-dot.active { background: var(--accent1); }
    .onboard-btn {
      width: 100%; padding: 13px; border: none;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: #fff; border-radius: var(--radius-sm); font-size: 0.9rem;
      font-weight: 600; cursor: pointer; transition: opacity 0.2s;
    }
    .onboard-btn:active { opacity: 0.85; }
    .onboard-skip { margin-top: 12px; font-size: 0.75rem; color: var(--text3); cursor: pointer; text-decoration: underline; }
  </style>
</head>
<body>

  <!-- –®–ê–ü–ö–ê -->
  <header>
    <div class="header-title">
      <h1>üåê –ì–æ–ª–æ—Å–æ–≤–æ–π –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫</h1>
      <span id="headerSubtitle">–†—É—Å ‚Üí üá∏üá¶ –ê—Ä–∞–±—Å–∫–∏–π</span>
    </div>
    <div style="display:flex;gap:6px;align-items:center">
      <button class="swap-btn" onclick="swapModes()" title="–ü–æ–º–µ–Ω—è—Ç—å —è–∑—ã–∫–∏ –º–µ—Å—Ç–∞–º–∏">‚áÑ</button>
      <button class="theme-btn" id="themeBtn" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">‚òÄÔ∏è</button>
    </div>
  </header>

  <div class="content">

    <!-- –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –±—Ä–∞—É–∑–µ—Ä -->
    <div class="msg warn" id="browserWarn">
      ‚ö†Ô∏è –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ <strong>Google Chrome</strong> –Ω–∞ Android. –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ –∏ –ø–µ—Ä–µ–≤–æ–¥ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –ª—é–±–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.
    </div>

    <!-- –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –Ω–µ—Ç TTS-–≥–æ–ª–æ—Å–∞ -->
    <div class="msg warn" id="ttsWarn" onclick="this.classList.remove('visible')" title="–ù–∞–∂–º–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è" style="cursor:pointer"></div>

    <!-- –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ -->
    <div class="msg warn" id="offlineWarn">
      üìµ –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞. –ü–µ—Ä–µ–≤–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
    </div>

    <!-- –í–ö–õ–ê–î–ö–ò -->
    <div class="tabs">
      <button class="tab active" id="tab-ru" onclick="setMode('ru')">
        –Ø –≥–æ–≤–æ—Ä—é<br>–ø–æ-—Ä—É—Å—Å–∫–∏
      </button>
      <button class="tab" id="tab-foreign" onclick="setMode('foreign')">
        –ú–Ω–µ –≥–æ–≤–æ—Ä—è—Ç<br>–Ω–∞ –¥—Ä—É–≥–æ–º —è–∑—ã–∫–µ
      </button>
    </div>

    <!-- –ë–õ–û–ö –í–í–û–î–ê -->
    <div class="card" id="inputCard">

      <!-- –í—ã–±–æ—Ä —è–∑—ã–∫–∞ (–æ–±–∞ —Ä–µ–∂–∏–º–∞) -->
      <div id="langPillsWrap">
        <div class="card-label" id="langPillsLabel">–ù–∞ –∫–∞–∫–æ–π —è–∑—ã–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å:</div>
        <div class="lang-pills">
          <button class="lang-pill active" data-lang="ar-SA" data-code="ar" onclick="selectForeignLang(this)">üá∏üá¶ –ê—Ä–∞–±—Å–∫–∏–π</button>
          <button class="lang-pill" data-lang="tr-TR" data-code="tr" onclick="selectForeignLang(this)">üáπüá∑ –¢—É—Ä–µ—Ü–∫–∏–π</button>
          <button class="lang-pill" data-lang="en-US" data-code="en" onclick="selectForeignLang(this)">üá¨üáß –ê–Ω–≥–ª–∏–π—Å–∫–∏–π</button>
          <button class="lang-pill" id="otherLangPill" onclick="showLangModal()">Ôºã –î—Ä—É–≥–æ–π</button>
        </div>
        <div style="height:16px"></div>
      </div>

      <!-- –ú–∏–∫—Ä–æ—Ñ–æ–Ω -->
      <div class="record-wrap">
        <button class="mic-btn" id="micBtn" onclick="toggleRecording()">üé§</button>
        <div class="record-hint" id="recordHint">–ù–∞–∂–º–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏</div>
      </div>

      <!-- –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ -->
      <div class="text-input-row">
        <input
          class="text-input" id="textInput" type="text"
          placeholder="–∏–ª–∏ –≤–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é..."
          onkeydown="if(event.key==='Enter') sendText()"
        />
        <button class="send-btn" onclick="sendText()" title="–ü–µ—Ä–µ–≤–µ—Å—Ç–∏">‚úàÔ∏è</button>
      </div>

      <!-- TTS —Å–∫–æ—Ä–æ—Å—Ç—å -->
      <div class="controls-row">
        <span class="controls-label">–°–∫–æ—Ä–æ—Å—Ç—å TTS:</span>
        <button class="speed-btn" data-rate="0.65" onclick="setTtsRate(this)" title="–ú–µ–¥–ª–µ–Ω–Ω–æ">üê¢</button>
        <button class="speed-btn" data-rate="0.88" onclick="setTtsRate(this)" title="–ù–æ—Ä–º–∞–ª—å–Ω–æ">‚ñ∂</button>
        <button class="speed-btn" data-rate="1.1"  onclick="setTtsRate(this)" title="–ë—ã—Å—Ç—Ä–æ">üêá</button>
      </div>

      <!-- –ê–≤—Ç–æ-—Ä–µ–∂–∏–º -->
      <div class="controls-row" style="margin-top:6px">
        <span class="controls-label">–†–µ–∂–∏–º:</span>
        <button class="speed-btn auto-btn active" data-auto="off"    onclick="setAutoMode(this)" title="–†—É—á–Ω–æ–π ‚Äî –∑–∞–ø–∏—Å—å —Ç–æ–ª—å–∫–æ –ø–æ –Ω–∞–∂–∞—Ç–∏—é">‚úï</button>
        <button class="speed-btn auto-btn"        data-auto="repeat" onclick="setAutoMode(this)" title="–ê–≤—Ç–æ-–∑–∞–ø–∏—Å—å ‚Äî –ø–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ —Å–Ω–æ–≤–∞ —Å–ª—É—à–∞–µ—Ç">üîÅ</button>
        <button class="speed-btn auto-btn"        data-auto="dialog" onclick="setAutoMode(this)" title="–î–∏–∞–ª–æ–≥ ‚Äî —á–µ—Ä–µ–¥—É–µ—Ç —Ç–≤–æ–π —è–∑—ã–∫ –∏ —è–∑—ã–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">üí¨</button>
        <span class="controls-label" id="autoModeLabel" style="margin-left:2px">—Ä—É—á–Ω–æ–π</span>
      </div>

      <!-- –°—Ç–∏–ª—å –ø–µ—Ä–µ–≤–æ–¥–∞ + –ì—Ä–æ–º–∫–æ—Å—Ç—å -->
      <div class="controls-row" style="margin-top:6px">
        <span class="controls-label">–°—Ç–∏–ª—å:</span>
        <button class="tone-btn active" id="tone-casual" onclick="setTone('casual')" title="–†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Å—Ç–∏–ª—å">üí¨ –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π</button>
        <button class="tone-btn" id="tone-formal" onclick="setTone('formal')" title="–§–æ—Ä–º–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å">ü§µ –§–æ—Ä–º–∞–ª—å–Ω—ã–π</button>
      </div>
      <div class="controls-row" style="margin-top:6px">
        <span class="controls-label">üîä</span>
        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.1" value="1" oninput="setVolume(this.value)" title="–ì—Ä–æ–º–∫–æ—Å—Ç—å TTS" />
      </div>

      <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–∏—Ç—É–∞—Ü–∏–∏ -->
      <input class="context-input" id="contextInput" type="text"
        placeholder="üìç –ö–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ): –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ, –≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç—É, –¥–µ–ª–æ–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞..." />

      <!-- –û—à–∏–±–∫–∞ -->
      <div class="msg err" id="errorMsg" style="margin-top:12px"></div>
    </div>


    <!-- –†–ê–°–ü–û–ó–ù–ê–ù–û -->
    <div class="card" id="recognizedCard" style="display:none">
      <div class="results-head">
        <span class="card-label">–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ</span>
        <button class="icon-btn" onclick="playOriginal()" title="–û–∑–≤—É—á–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª">‚ñ∂</button>
      </div>
      <div class="recognized-box" id="recognizedBox" contenteditable="true" oninput="onRecognizedEdit()"></div>
      <button class="retranslate-btn" id="retranslateBtn" onclick="retranslateEdited()">‚Ü∫ –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–Ω–æ–≤–∞</button>
    </div>

    <!-- –ü–ï–†–ï–í–û–î–´ -->
    <div class="card" id="resultsCard" style="display:none">
      <div class="results-head">
        <span class="card-label">–ü–µ—Ä–µ–≤–æ–¥—ã</span>
        <button class="icon-btn" id="repeatBtn" onclick="repeatTTS()" style="display:none" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –≤—Å—ë">üîÅ</button>
      </div>
      <div class="translations" id="translationsBox"></div>
    </div>

    <!-- –ß–ê–¢ (–¥–∏–∞–ª–æ–≥) -->
    <div class="card" id="chatCard" style="display:none">
      <div class="results-head">
        <span class="card-label">üí¨ –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞</span>
        <button class="icon-btn" onclick="clearChat()" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">‚úï</button>
      </div>
      <div class="chat-view" id="chatView"></div>
    </div>

    <!-- –§–†–ê–ó–û–í–ù–ò–ö -->
    <div class="card" id="phrasebookCard">
      <div class="collapsible-head" onclick="togglePhrasebook()">
        <span class="card-label">üìö –§—Ä–∞–∑–æ–≤–Ω–∏–∫</span>
        <span class="toggle-icon" id="phraseToggleIcon">‚ñº</span>
      </div>
      <div id="phrasebookBody" style="display:none">
        <div style="display:flex;gap:8px;margin-top:10px;margin-bottom:4px">
          <input class="context-input" id="phraseSearch" type="text"
            placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Ñ—Ä–∞–∑–∞–º..." oninput="filterPhrases(this.value)"
            style="margin-top:0;flex:1" />
          <button class="tone-btn" onclick="promptAddPhrase()" title="–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ—é —Ñ—Ä–∞–∑—É" style="flex-shrink:0">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="phrase-categories" id="phraseCategories"></div>
        <div class="phrase-list" id="phraseList"></div>
      </div>
    </div>

    <!-- –ò–ó–ë–†–ê–ù–ù–û–ï -->
    <div class="card" id="favCard" style="display:none">
      <div class="collapsible-head" onclick="toggleFavSection()">
        <span class="card-label">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
        <span class="toggle-icon" id="favToggleIcon">‚ñº</span>
      </div>
      <div id="favBody" style="display:none">
        <div class="fav-section" id="favList"></div>
      </div>
    </div>

    <!-- –ò–°–¢–û–†–ò–Ø -->
    <div class="card" id="historyCard">
      <div class="collapsible-head" onclick="toggleHistory()">
        <span class="card-label">üïê –ò—Å—Ç–æ—Ä–∏—è</span>
        <span class="toggle-icon" id="histToggleIcon">‚ñº</span>
      </div>
      <div class="history-body" id="historyBody" style="display:none">
        <div class="history-list" id="historyList"></div>
      </div>
    </div>

  </div>

  <!-- –§–£–¢–ï–† -->
  <footer>
    –ü–µ—Ä–µ–≤–æ–¥: Groq Llama 3.3 ¬∑ –ì–æ–ª–æ—Å: –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π TTS ¬∑ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ: Web Speech API<br>
    <div id="wordCounter" class="word-counter"></div>
  </footer>

  <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –í–´–ë–û–†–ê –Ø–ó–´–ö–ê -->
  <div class="lang-modal-overlay" id="langModalOverlay" onclick="hideLangModal()">
    <div class="lang-modal" onclick="event.stopPropagation()">
      <div class="lang-modal-title">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</div>
      <div class="lang-modal-grid" id="langModalGrid"></div>
    </div>
  </div>

  <!-- –û–ù–ë–û–†–î–ò–ù–ì -->
  <div class="onboard-overlay hidden" id="onboardOverlay">
    <div class="onboard-modal">
      <div class="onboard-icon" id="onboardIcon">üåê</div>
      <div class="onboard-title" id="onboardTitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</div>
      <div class="onboard-text" id="onboardText"></div>
      <div class="onboard-dots" id="onboardDots"></div>
      <button class="onboard-btn" id="onboardBtn" onclick="onboardNext()">–î–∞–ª–µ–µ ‚Üí</button>
      <div class="onboard-skip" onclick="closeOnboarding()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</div>
    </div>
  </div>

  <!-- FULLSCREEN OVERLAY -->
  <div id="fsOverlay" class="fs-overlay">
    <div class="fs-lang" id="fsLang"></div>
    <div class="fs-text" id="fsText"></div>
    <button class="fs-close" onclick="closeFullscreen()">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
  </div>

<script>
/* ============================================================
   –ö–û–ù–§–ò–ì
============================================================ */
// –ö–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ Cloudflare Worker ‚Äî –≤ –∫–æ–¥–µ –µ–≥–æ –Ω–µ—Ç
const PROXY_URL = 'https://rough-cherry-2b43.timtim044.workers.dev/';
const HISTORY_KEY        = 'lv_history';
const CHARS_KEY          = 'lv_chars';
const TR_CACHE_KEY       = 'lv_tr_cache';
const CHAT_KEY           = 'lv_chat';
const CUSTOM_PHRASES_KEY = 'lv_custom_phrases';

// –ù–∞–∑–≤–∞–Ω–∏—è —è–∑—ã–∫–æ–≤ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞ AI
const LANG_NAMES = {
  ar: 'Arabic', tr: 'Turkish', en: 'English', ru: 'Russian',
  fr: 'French', de: 'German', es: 'Spanish', it: 'Italian',
  'zh-Hans': 'Chinese (Simplified)', ja: 'Japanese', ko: 'Korean',
  hi: 'Hindi', fa: 'Persian', he: 'Hebrew', pt: 'Portuguese',
  pl: 'Polish', uk: 'Ukrainian', nl: 'Dutch', ro: 'Romanian', el: 'Greek',
};

/* ============================================================
   –°–û–°–¢–û–Ø–ù–ò–ï
============================================================ */
let mode             = 'ru';
let foreignLang      = 'ar-SA';
let foreignCode      = 'ar';
let isRecording      = false;
let recognition      = null;
let ttsQueue         = [];
let ttsPlaying       = false;
let ttsRate          = 0.88;
let ttsVolume        = 1.0;
let translateStyle   = 'casual';  // 'casual' | 'formal'
let lastSuccessTexts = [];
let wakeLock         = null;
let histOpen         = false;
let favOpen          = false;
let translationSeq   = 0;
let currentAbort       = null;
let autoMode           = 'off';
let pendingAutoRestart = false;
let autoRestartTimer   = null;
let phrasebookOpen     = false;
let activePhraseCategory = null;
let onboardStep        = 0;

// –ù–µ–ª–∞—Ç–∏–Ω—Å–∫–∏–µ —è–∑—ã–∫–∏ ‚Äî –Ω—É–∂–Ω–∞ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è
const NON_LATIN = new Set(['ar','ja','ko','hi','fa','he','zh-Hans','el']);
const FAVORITES_KEY = 'lv_favorites';

/* ============================================================
   –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –Ø–ó–´–ö–û–í
============================================================ */
const TARGETS = {
  ru: [
    { code: 'ar', speech: 'ar-SA', name: '–ê—Ä–∞–±—Å–∫–∏–π',   flag: 'üá∏üá¶', rtl: true  },
    { code: 'tr', speech: 'tr-TR', name: '–¢—É—Ä–µ—Ü–∫–∏–π',   flag: 'üáπüá∑', rtl: false },
    { code: 'en', speech: 'en-US', name: '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π', flag: 'üá¨üáß', rtl: false },
  ],
  foreign: [
    { code: 'ru', speech: 'ru-RU', name: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫', rtl: false },
  ],
};
// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —è–∑—ã–∫–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
const OTHER_LANGS = [
  { code: 'fr', speech: 'fr-FR', name: '–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π',    flag: 'üá´üá∑', rtl: false },
  { code: 'de', speech: 'de-DE', name: '–ù–µ–º–µ—Ü–∫–∏–π',       flag: 'üá©üá™', rtl: false },
  { code: 'es', speech: 'es-ES', name: '–ò—Å–ø–∞–Ω—Å–∫–∏–π',      flag: 'üá™üá∏', rtl: false },
  { code: 'it', speech: 'it-IT', name: '–ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–π',    flag: 'üáÆüáπ', rtl: false },
  { code: 'zh-Hans', speech: 'zh-CN', name: '–ö–∏—Ç–∞–π—Å–∫–∏–π', flag: 'üá®üá≥', rtl: false },
  { code: 'ja', speech: 'ja-JP', name: '–Ø–ø–æ–Ω—Å–∫–∏–π',       flag: 'üáØüáµ', rtl: false },
  { code: 'ko', speech: 'ko-KR', name: '–ö–æ—Ä–µ–π—Å–∫–∏–π',      flag: 'üá∞üá∑', rtl: false },
  { code: 'hi', speech: 'hi-IN', name: '–•–∏–Ω–¥–∏',          flag: 'üáÆüá≥', rtl: false },
  { code: 'fa', speech: 'fa-IR', name: '–ü–µ—Ä—Å–∏–¥—Å–∫–∏–π',     flag: 'üáÆüá∑', rtl: true  },
  { code: 'he', speech: 'he-IL', name: '–ò–≤—Ä–∏—Ç',          flag: 'üáÆüá±', rtl: true  },
  { code: 'pt', speech: 'pt-BR', name: '–ü–æ—Ä—Ç—É–≥–∞–ª—å—Å–∫–∏–π',  flag: 'üáßüá∑', rtl: false },
  { code: 'pl', speech: 'pl-PL', name: '–ü–æ–ª—å—Å–∫–∏–π',       flag: 'üáµüá±', rtl: false },
  { code: 'uk', speech: 'uk-UA', name: '–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π',     flag: 'üá∫üá¶', rtl: false },
  { code: 'nl', speech: 'nl-NL', name: '–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—Å–∫–∏–π',  flag: 'üá≥üá±', rtl: false },
  { code: 'ro', speech: 'ro-RO', name: '–†—É–º—ã–Ω—Å–∫–∏–π',      flag: 'üá∑üá¥', rtl: false },
  { code: 'el', speech: 'el-GR', name: '–ì—Ä–µ—á–µ—Å–∫–∏–π',      flag: 'üá¨üá∑', rtl: false },
];
// –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è doTranslate –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
const ALL_RU_TARGETS = [...TARGETS.ru, ...OTHER_LANGS];
const ALL_LANGS = [...ALL_RU_TARGETS, ...TARGETS.foreign];


/* ============================================================
   –¢–ï–ú–ê
============================================================ */
(function initTheme() {
  const saved = localStorage.getItem('theme')
    || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
  setTheme(saved, false);
})();

function setTheme(theme, save = true) {
  document.documentElement.setAttribute('data-theme', theme === 'light' ? 'light' : 'dark');
  document.getElementById('themeBtn').textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
  const meta = document.getElementById('themeColorMeta');
  if (meta) meta.content = theme === 'light' ? '#0984e3' : '#667eea';
  if (save) localStorage.setItem('theme', theme);
}
document.getElementById('themeBtn').addEventListener('click', () => {
  const current = localStorage.getItem('theme') || 'dark';
  setTheme(current === 'dark' ? 'light' : 'dark');
});

/* ============================================================
   –†–ï–ñ–ò–ú
============================================================ */
function setMode(m) {
  if (isRecording) { recognition && recognition.stop(); }
  mode = m;
  localStorage.setItem('mode', m);
  document.getElementById('tab-ru').classList.toggle('active', m === 'ru');
  document.getElementById('tab-foreign').classList.toggle('active', m === 'foreign');
  document.getElementById('langPillsLabel').textContent =
    m === 'ru' ? '–ù–∞ –∫–∞–∫–æ–π —è–∑—ã–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å:' : '–Ø–∑—ã–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:';
  updateSubtitle();
  resetUI();
}
function selectForeignLang(btn) {
  document.querySelectorAll('.lang-pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  foreignLang = btn.dataset.lang;
  foreignCode = btn.dataset.code;
  localStorage.setItem('foreignLang', foreignLang);
  localStorage.setItem('foreignCode', foreignCode);
  updateSubtitle();
}

function updateSubtitle() {
  const el = document.getElementById('headerSubtitle');
  if (!el) return;
  if (mode === 'ru') {
    const lang = ALL_RU_TARGETS.find(l => l.code === foreignCode);
    el.textContent = lang ? `–†—É—Å ‚Üí ${lang.flag} ${lang.name}` : '–†—É—Å ‚Üí ?';
  } else {
    const lang = ALL_LANGS.find(l => l.code === foreignCode);
    el.textContent = lang ? `${lang.flag} ${lang.name} ‚Üí –†—É—Å` : '? ‚Üí –†—É—Å';
  }
}

function playOriginal() {
  const text = document.getElementById('recognizedBox').textContent;
  if (!text || text === '...') return;
  stopTTS();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = getInputLang(); u.rate = ttsRate;
  const voices = window.speechSynthesis.getVoices();
  const prefix = u.lang.split('-')[0];
  const v = voices.find(v => v.lang === u.lang) || voices.find(v => v.lang.startsWith(prefix));
  if (v) u.voice = v;
  window.speechSynthesis.speak(u);
}

function shareTranslation(code) {
  const el   = document.getElementById(`text-${code}`);
  const text = el?.dataset.translated || el?.textContent;
  if (!text) return;
  if (navigator.share) {
    navigator.share({ text }).catch(() => {});
  } else {
    navigator.clipboard.writeText(text).then(() => {
      const btn = document.getElementById(`share-${code}`);
      if (btn) { btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'; setTimeout(() => { btn.textContent = 'üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è'; }, 2000); }
    }).catch(() => showError('–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–µ —É–¥–∞–ª–æ—Å—å'));
  }
}

/* ============================================================
   –°–ë–†–û–° UI
============================================================ */
function resetUI() {
  if (currentAbort) { currentAbort.abort(); currentAbort = null; }
  translationSeq++;
  stopTTS();
  document.getElementById('recognizedCard').style.display = 'none';
  document.getElementById('resultsCard').style.display    = 'none';
  document.getElementById('recognizedBox').textContent    = '';
  document.getElementById('translationsBox').innerHTML    = '';
  document.getElementById('repeatBtn').style.display      = 'none';
  const retBtn = document.getElementById('retranslateBtn');
  if (retBtn) retBtn.classList.remove('show');
  lastSuccessTexts = [];
  hideError();
}

/* ============================================================
   –û–®–ò–ë–ö–ò
============================================================ */
function showError(msg) {
  const el = document.getElementById('errorMsg');
  el.textContent = msg; el.classList.add('visible');
}
function hideError() {
  document.getElementById('errorMsg').classList.remove('visible');
}

/* ============================================================
   –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –†–ï–ß–ò
============================================================ */
function getInputLang() { return mode === 'ru' ? 'ru-RU' : foreignLang; }
function getInputCode() { return mode === 'ru' ? 'ru'    : foreignCode; }

function toggleRecording() {
  if (document.getElementById('micBtn').classList.contains('busy')) return;
  if (isRecording) { recognition && recognition.stop(); }
  else { startRecording(); }
}

function startRecording() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    showError('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ Google Chrome.');
    return;
  }
  hideError(); resetUI();
  recognition = new SR();
  recognition.lang            = getInputLang();
  recognition.continuous      = false;
  recognition.interimResults  = true;
  recognition.maxAlternatives = 1;

  let micStarted = false;   // —Ñ–ª–∞–≥: onstart —Å—Ä–∞–±–æ—Ç–∞–ª?

  recognition.onstart = () => {
    micStarted  = true;
    isRecording = true;
    navigator.vibrate && navigator.vibrate(50);
    requestWakeLock();
    document.getElementById('micBtn').classList.add('recording');
    document.getElementById('micBtn').textContent = '‚èπ';
    document.getElementById('recordHint').textContent = '–°–ª—É—à–∞—é... –ì–æ–≤–æ—Ä–∏—Ç–µ';
    document.getElementById('recordHint').classList.add('live');
    document.getElementById('recognizedCard').style.display = 'block';
    document.getElementById('recognizedBox').textContent = '...';
    document.getElementById('recognizedBox').classList.add('empty');
  };

  recognition.onresult = (e) => {
    const last       = e.results[e.results.length - 1];
    const transcript = last[0].transcript.trim();
    const box        = document.getElementById('recognizedBox');
    box.textContent  = transcript;
    box.classList.remove('empty');
    if (last.isFinal && transcript) doTranslate(transcript, getInputCode());
  };

  recognition.onerror = (e) => {
    stopRecordingUI();
    const msgs = {
      'not-allowed': '–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Chrome.',
      'no-speech':   '–ù–∏—á–µ–≥–æ –Ω–µ —É—Å–ª—ã—à–∞–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.',
      'network':     '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ —Ä–µ—á–∏.',
      // aborted –±–µ–∑ onstart = –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è (–Ω–µ—Ç Google-—Å–µ—Ä–≤–∏—Å–æ–≤ –∏–ª–∏ –¥—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞)
      'aborted':     micStarted ? '' : '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Google –∏ –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.',
    };
    const msg = msgs[e.error] ?? ('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ' + e.error);
    if (msg) showError(msg);
  };

  recognition.onend = () => {
    if (!micStarted) {
      showError('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Google? –û—à–∏–±–∫–∞: onend –±–µ–∑ onstart.');
    }
    stopRecordingUI();
  };

  try { recognition.start(); }
  catch(err) { showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω: ' + err.message); }
}

function stopRecordingUI() {
  if (!isRecording) return;   // guard: onend –≤—Å–µ–≥–¥–∞ —Å–ª–µ–¥—É–µ—Ç –∑–∞ onerror
  isRecording = false;
  if (wakeLock) { wakeLock.release().catch(() => {}); wakeLock = null; }
  navigator.vibrate && navigator.vibrate([30, 50, 30]);
  document.getElementById('micBtn').classList.remove('recording');
  document.getElementById('micBtn').textContent = 'üé§';
  document.getElementById('recordHint').textContent = '–ù–∞–∂–º–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏';
  document.getElementById('recordHint').classList.remove('live');
}

/* ============================================================
   –¢–ï–ö–°–¢–û–í–´–ô –í–í–û–î
============================================================ */
function sendText() {
  if (document.getElementById('micBtn').classList.contains('busy')) return;
  const val = document.getElementById('textInput').value.trim();
  if (!val) return;
  hideError(); resetUI();
  document.getElementById('recognizedCard').style.display = 'block';
  const box = document.getElementById('recognizedBox');
  box.textContent = val; box.classList.remove('empty');
  document.getElementById('textInput').value = '';
  doTranslate(val, getInputCode(), true);   // fromText=true ‚Üí –≤–µ—Ä–Ω—ë–º —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –ø—Ä–æ–≤–∞–ª–∏—Ç—Å—è
}

/* ============================================================
   –£–¢–ò–õ–ò–¢–ê: fetch —Å –∞–≤—Ç–æ-—Ä–µ—Ç—Ä–∞–µ–º (3 –ø–æ–ø—ã—Ç–∫–∏, –ø–∞—É–∑–∞ 700/1400/2100 –º—Å)
============================================================ */
async function fetchWithRetry(url, options, attempts = 3) {
  for (let i = 0; i < attempts; i++) {
    try {
      const r = await fetch(url, options);
      if (r.ok || r.status === 429) return r; // 429 ‚Äî –ª–∏–º–∏—Ç, –Ω–µ —Ä–µ—Ç—Ä–∞–∏—Ç—å
      if (i === attempts - 1) return r;
    } catch(e) {
      if (e.name === 'AbortError') throw e;   // –∞–±–æ—Ä—Ç ‚Äî –±–µ–∑ —Ä–µ—Ç—Ä–∞—è
      if (i === attempts - 1) throw e;
    }
    await new Promise((res, rej) => {
      const t = setTimeout(res, 700 * (i + 1));
      if (options.signal) {
        options.signal.addEventListener('abort', () => {
          clearTimeout(t);
          rej(Object.assign(new Error('Aborted'), { name: 'AbortError' }));
        }, { once: true });
      }
    });
  }
}

/* ============================================================
   –ö–≠–® –ü–ï–†–ï–í–û–î–û–í (localStorage, –¥–æ 200 –∑–∞–ø–∏—Å–µ–π)
============================================================ */
function getCachedTranslation(text, from, codes) {
  try {
    const cache = JSON.parse(localStorage.getItem(TR_CACHE_KEY) || '{}');
    return cache[`${from}|${[...codes].sort().join(',')}|${text}`] || null;
  } catch { return null; }
}
function setCachedTranslation(text, from, codes, result) {
  try {
    const cache = JSON.parse(localStorage.getItem(TR_CACHE_KEY) || '{}');
    const key   = `${from}|${[...codes].sort().join(',')}|${text}`;
    cache[key]  = result;
    const keys  = Object.keys(cache);
    if (keys.length > 200) keys.slice(0, 50).forEach(k => delete cache[k]);
    localStorage.setItem(TR_CACHE_KEY, JSON.stringify(cache));
  } catch {}
}

/* ============================================================
   –ü–ï–†–ï–í–û–î ‚Äî —á–µ—Ä–µ–∑ API
============================================================ */
// –ü–µ—Ä–µ–≤–æ–¥ —á–µ—Ä–µ–∑ Groq (Llama 3.3) ‚Äî —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π –∏–ª–∏ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç { ar: "...", ar_roman: "...", ja: "...", ja_roman: "...", tr: "...", en: "..." }
async function translateTexts(text, from, toCodes, signal, retrying = false) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–µ)
  if (!retrying) {
    const cached = getCachedTranslation(text, from, toCodes);
    if (cached) return cached;
  }

  const fromName    = LANG_NAMES[from] || from;
  const toLangs     = toCodes.map(c => LANG_NAMES[c] || c).join(', ');
  const nonLatinIn  = toCodes.filter(c => NON_LATIN.has(c));
  const romanKeys   = nonLatinIn.map(c => `"${c}_roman": "romanization of ${LANG_NAMES[c]||c} in Latin script"`);
  const jsonKeys    = [...toCodes.map(c => `"${c}": "translation"`), ...romanKeys].join(', ');
  const context     = (document.getElementById('contextInput')?.value || '').trim();
  const styleNote   = translateStyle === 'formal'
    ? 'Use formal, polite register ‚Äî suitable for business or official situations.'
    : 'Use natural conversational language ‚Äî as a real person would say it in everyday life, NOT word-for-word literal.';
  const contextNote = context ? `\nSituation context: ${context}` : '';
  const romanNote   = nonLatinIn.length
    ? `\nFor each non-Latin script language, also include "${nonLatinIn.map(c=>c+'_roman').join('", "')}" with romanized pronunciation.`
    : '';

  // –ü—Ä–∏ retry ‚Äî —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∂—ë—Å—Ç–∫–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –ø—Ä–æ JSON
  const prompt = retrying
    ? `Translate from ${fromName} to ${toLangs}. Text: "${text.replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"\nReturn ONLY valid JSON, nothing else: {${jsonKeys}}`
    : `You are a travel translator app powered by AI.
${styleNote}${contextNote}

Source language: ${fromName}
Translate to: ${toLangs}${romanNote}

Text to translate: "${text.replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"

Return ONLY a valid JSON object with this exact structure (no markdown, no explanation):
{${jsonKeys}}`;

  const resp = await fetchWithRetry(PROXY_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: { temperature: 0.2, maxOutputTokens: 1024 }
    }),
    signal,
  });
  if (!resp.ok) {
    if (resp.status === 429) throw new Error('QUOTA_EXCEEDED');
    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + resp.status);
  }
  const data    = await resp.json();
  if (data.error) throw new Error(data.error.message || '–û—à–∏–±–∫–∞ API');
  const candidate = data.candidates?.[0];
  if (!candidate) throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø–µ—Ä–µ–≤–æ–¥–∞');
  if (candidate.finishReason === 'SAFETY') throw new Error('–ó–∞–ø—Ä–æ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —Ñ–∏–ª—å—Ç—Ä–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
  const content = candidate.content?.parts?.[0]?.text || '';
  if (!content) throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç');
  // –ò–∑–≤–ª–µ–∫–∞–µ–º JSON ‚Äî –º–æ–¥–µ–ª—å –∏–Ω–æ–≥–¥–∞ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤ ```json ... ```
  const jsonMatch = content.match(/\{[\s\S]*\}/);
  if (!jsonMatch) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: ' + content.slice(0, 100));
  // –ú–æ–¥–µ–ª—å –∏–Ω–æ–≥–¥–∞ –≤—Å—Ç–∞–≤–ª—è–µ—Ç –±—É–∫–≤–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –≤–Ω—É—Ç—Ä–∏ JSON-—Å—Ç—Ä–æ–∫ ‚Üí sanitize
  const sanitized = jsonMatch[0].replace(/("(?:[^"\\]|\\.)*")|[\r\n]/g,
    (m, str) => str ? str.replace(/\n/g, '\\n').replace(/\r/g, '') : m
  );
  try {
    const result = JSON.parse(sanitized);
    setCachedTranslation(text, from, toCodes, result); // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
    return result;
  } catch {
    if (!retrying) return translateTexts(text, from, toCodes, signal, true); // –æ–¥–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON: ' + sanitized.slice(0, 120));
  }
}

// –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è –Ω–µ–ª–∞—Ç–∏–Ω—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ (–±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞)
async function transliterateScript(text, langCode, signal) {
  const lang = ALL_LANGS.find(l => l.code === langCode);
  const langName = lang ? lang.name : 'the given';
  try {
    const resp = await fetch(PROXY_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: `Romanize this ${langName} text to Latin script (transliteration only, no translation): "${text.replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"\nReturn ONLY the romanized text, nothing else.` }] }],
        generationConfig: { temperature: 0, maxOutputTokens: 200 }
      }),
      signal,
    });
    if (!resp.ok) return null;
    const data = await resp.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || null;
  } catch { return null; }
}

async function doTranslate(text, fromCode, fromText = false) {
  if (!navigator.onLine) { showError('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.'); return; }
  // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å –µ—Å–ª–∏ –æ–Ω –µ—â—ë –∏–¥—ë—Ç
  if (currentAbort) currentAbort.abort();
  currentAbort = new AbortController();
  const signal = currentAbort.signal;
  const mySeq  = ++translationSeq;
  const targets = mode === 'ru'
    ? ALL_RU_TARGETS.filter(t => t.code === foreignCode)
    : TARGETS.foreign;
  const box = document.getElementById('translationsBox');
  box.innerHTML = '';
  document.getElementById('resultsCard').style.display = 'block';
  document.getElementById('micBtn').classList.add('busy');
  document.getElementById('repeatBtn').style.display = 'none';

  targets.forEach(lang => {
    box.insertAdjacentHTML('beforeend', `
      <div class="tr-card" id="card-${lang.code}">
        <div class="tr-header">
          <div class="tr-lang">
            <span class="tr-flag">${lang.flag}</span>
            <span class="tr-name">${lang.name}</span>
          </div>
        </div>
        <div class="tr-text loading" id="text-${lang.code}" dir="${lang.rtl ? 'rtl' : 'ltr'}">–ü–µ—Ä–µ–≤–æ–¥–∏–º...</div>
        <div class="tr-translit" id="translit-${lang.code}"></div>
        <div class="tr-actions" id="actions-${lang.code}" style="display:none">
          <button class="tr-btn play-btn" id="play-${lang.code}"
            onclick="speakOne('${lang.code}', '${lang.speech}')">‚ñ∂ –û–∑–≤—É—á–∏—Ç—å</button>
          <button class="tr-btn show-btn"
            onclick="showFullscreen('${lang.code}')">üëÅ –ü–æ–∫–∞–∑–∞—Ç—å</button>
          <button class="tr-btn copy-btn" id="copy-${lang.code}"
            onclick="copyOne('${lang.code}')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="tr-btn share-btn" id="share-${lang.code}"
            onclick="shareTranslation('${lang.code}')">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
          <button class="tr-btn fav-btn" id="fav-${lang.code}"
            onclick="toggleFavorite('${lang.code}')">‚òÜ</button>
        </div>
      </div>
    `);
  });

  // –û–¥–∏–Ω batch-–∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö —è–∑—ã–∫–æ–≤ —Å—Ä–∞–∑—É
  let translations = {};
  let quotaError   = false;
  try {
    translations = await translateTexts(text, fromCode, targets.map(t => t.code), signal);
  } catch(e) {
    if (e.name === 'AbortError') { document.getElementById('micBtn').classList.remove('busy'); return; }
    if (e.message === 'QUOTA_EXCEEDED') {
      quotaError = true;
    } else {
      showError('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: ' + e.message);
    }
  }

  document.getElementById('micBtn').classList.remove('busy');
  if (mySeq !== translationSeq) return;
  currentAbort = null;

  const successTexts  = [];
  const romanPromises = new Map(); // code ‚Üí Promise<string|null>

  targets.forEach(lang => {
    const t  = translations[lang.code];
    const el = document.getElementById(`text-${lang.code}`);
    if (t) {
      el.textContent = t; el.classList.remove('loading');
      el.dataset.translated = t; el.dataset.speech = lang.speech;
      document.getElementById(`actions-${lang.code}`).style.display = 'flex';
      successTexts.push({ code: lang.code, speech: lang.speech, text: t });
      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–≤–µ–∑–¥—É
      const isFaved = getFavorites().some(f => f.code === lang.code && f.text === t);
      const favBtn  = document.getElementById(`fav-${lang.code}`);
      if (favBtn) { favBtn.textContent = isFaved ? '‚òÖ' : '‚òÜ'; favBtn.classList.toggle('starred', isFaved); }
      // –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–∏—Å –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
      if (NON_LATIN.has(lang.code)) {
        const roman = translations[`${lang.code}_roman`];
        const tel   = document.getElementById(`translit-${lang.code}`);
        if (roman && tel) {
          tel.textContent = roman;
          romanPromises.set(lang.code, Promise.resolve(roman));
        } else if (tel && t) {
          const p = transliterateScript(t, lang.code, signal)
            .then(r => { if (r && tel) tel.textContent = r; return r || null; })
            .catch(() => null);
          romanPromises.set(lang.code, p);
        }
      }
    } else {
      el.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–≤–µ—Å—Ç–∏';
      el.classList.remove('loading'); el.classList.add('err-text');
    }
  });

  if (quotaError) {
    showError('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (30/–º–∏–Ω). –ü–æ–¥–æ–∂–¥–∏—Ç–µ ~1 –º–∏–Ω—É—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
  }

  if (successTexts.length) {
    lastSuccessTexts = successTexts;
    document.getElementById('repeatBtn').style.display = 'flex';
    trackApiWords(text, targets.length);
    autoPlay(successTexts, true);
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–∞—Ç-–∏—Å—Ç–æ—Ä–∏—é –≤ —Ä–µ–∂–∏–º–µ –¥–∏–∞–ª–æ–≥–∞
    if (autoMode === 'dialog') {
      const firstTr = successTexts[0];
      const roman   = firstTr && NON_LATIN.has(firstTr.code)
        ? (document.getElementById(`translit-${firstTr.code}`)?.textContent || '') : '';
      appendChatBubble(text, fromCode, firstTr?.text || '', firstTr?.code || '', roman);
    }
    setTimeout(() => {
      document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 150);
    // –ñ–¥—ë–º —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏ ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å roman (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç UI)
    const romanResults = new Map();
    await Promise.all([...romanPromises.entries()].map(async ([code, p]) => {
      const r = await p;
      if (r) romanResults.set(code, r);
    }));
    if (mySeq === translationSeq) {
      saveHistory(text, fromCode, successTexts.map(t => ({ ...t, roman: romanResults.get(t.code) || null })));
    }
  } else if (fromText) {
    const inp = document.getElementById('textInput');
    if (!inp.value) inp.value = text;
  }
}

/* ============================================================
   –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –°–û–•–†–ê–ù–Å–ù–ù–´–• –ü–ï–†–ï–í–û–î–û–í (–±–µ–∑ API)
   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: –∏—Å—Ç–æ—Ä–∏—è
============================================================ */
function displaySavedTranslations(originalText, fromCode, modeKey, savedTranslations) {
  // –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ —è–∑—ã–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –µ—Å—Ç—å –≤ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–∞—Ö
  const targets = savedTranslations
    .map(s => ALL_LANGS.find(l => l.code === s.code))
    .filter(Boolean);
  const box = document.getElementById('translationsBox');
  box.innerHTML = '';
  document.getElementById('recognizedCard').style.display = 'block';
  document.getElementById('resultsCard').style.display    = 'block';

  const rbox = document.getElementById('recognizedBox');
  rbox.textContent = originalText;
  rbox.classList.remove('empty');

  const successTexts = [];
  targets.forEach(lang => {
    const saved = savedTranslations.find(t => t.code === lang.code);
    if (!saved) return;

    box.insertAdjacentHTML('beforeend', `
      <div class="tr-card" id="card-${lang.code}">
        <div class="tr-header">
          <div class="tr-lang">
            <span class="tr-flag">${lang.flag}</span>
            <span class="tr-name">${lang.name}</span>
          </div>
        </div>
        <div class="tr-text" id="text-${lang.code}" dir="${lang.rtl ? 'rtl' : 'ltr'}"></div>
        <div class="tr-translit" id="translit-${lang.code}"></div>
        <div class="tr-actions" id="actions-${lang.code}" style="display:flex">
          <button class="tr-btn play-btn" id="play-${lang.code}"
            onclick="speakOne('${lang.code}', '${lang.speech}')">‚ñ∂ –û–∑–≤—É—á–∏—Ç—å</button>
          <button class="tr-btn show-btn"
            onclick="showFullscreen('${lang.code}')">üëÅ –ü–æ–∫–∞–∑–∞—Ç—å</button>
          <button class="tr-btn copy-btn" id="copy-${lang.code}"
            onclick="copyOne('${lang.code}')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="tr-btn share-btn" id="share-${lang.code}"
            onclick="shareTranslation('${lang.code}')">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
          <button class="tr-btn fav-btn" id="fav-${lang.code}"
            onclick="toggleFavorite('${lang.code}')">‚òÜ</button>
        </div>
      </div>
    `);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ JS (–±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–µ—Ç XSS)
    const el = document.getElementById(`text-${lang.code}`);
    el.textContent        = saved.text;
    el.dataset.translated = saved.text;
    el.dataset.speech     = lang.speech;

    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–≤–µ–∑–¥—É –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    const isFaved = getFavorites().some(f => f.code === lang.code && f.text === saved.text);
    const favBtn  = document.getElementById(`fav-${lang.code}`);
    if (favBtn) { favBtn.textContent = isFaved ? '‚òÖ' : '‚òÜ'; favBtn.classList.toggle('starred', isFaved); }

    // –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è: –±–µ—Ä—ë–º –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ API) –∏–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º
    if (NON_LATIN.has(lang.code)) {
      const tel = document.getElementById(`translit-${lang.code}`);
      if (saved.roman && tel) {
        tel.textContent = saved.roman;
      } else if (tel) {
        transliterateScript(saved.text, lang.code).then(roman => {
          if (roman && tel) tel.textContent = roman;
        });
      }
    }

    successTexts.push({ code: lang.code, speech: lang.speech, text: saved.text });
  });

  lastSuccessTexts = successTexts;
  document.getElementById('repeatBtn').style.display = successTexts.length ? 'flex' : 'none';
  if (successTexts.length) {
    setTimeout(() => {
      document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
  }
  return successTexts;
}

/* ============================================================
   TTS
============================================================ */
function stopTTS() {
  window.speechSynthesis.cancel();
  ttsQueue = []; ttsPlaying = false;
  pendingAutoRestart = false;
  if (autoRestartTimer) { clearTimeout(autoRestartTimer); autoRestartTimer = null; }
  document.querySelectorAll('.play-btn').forEach(b => b.classList.remove('playing'));
}
function autoPlay(list, fromTranslation = false) {
  stopTTS();  // —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç pendingAutoRestart
  ttsQueue = [...list];
  pendingAutoRestart = fromTranslation;
  playNext();
}
function repeatTTS() { if (lastSuccessTexts.length) autoPlay([...lastSuccessTexts]); }

function playNext() {
  if (!ttsQueue.length) {
    ttsPlaying = false;
    if (pendingAutoRestart) { pendingAutoRestart = false; scheduleAutoRestart(); }
    return;
  }
  ttsPlaying = true;
  const item    = ttsQueue.shift();
  const playBtn = document.getElementById(`play-${item.code}`);
  if (playBtn) playBtn.classList.add('playing');

  const u = new SpeechSynthesisUtterance(item.text);
  u.lang  = item.speech; u.rate = ttsRate; u.pitch = 1; u.volume = ttsVolume;

  const voices = window.speechSynthesis.getVoices();
  const prefix = item.speech.split('-')[0];
  const isMale = v => /male|–º—É–∂—Å–∫–æ–π|man\b/i.test(v.name) && !/female|–∂–µ–Ω—Å–∫–∏–π/i.test(v.name);
  const voice  = voices.find(v => v.lang === item.speech && isMale(v))
              || voices.find(v => v.lang.startsWith(prefix) && isMale(v))
              || voices.find(v => v.lang === item.speech)
              || voices.find(v => v.lang.startsWith(prefix));
  if (voice) u.voice = voice;

  const resumeTimer = setInterval(() => {
    if (window.speechSynthesis.paused) window.speechSynthesis.resume();
  }, 500);

  const words    = Math.max(item.text.length / 4, item.text.split(/\s+/).length); // CJK-safe
  const timeout  = Math.max(words * 700, 8000) + 3000;
  const watchdog = setTimeout(() => {
    clearInterval(resumeTimer);
    window.speechSynthesis.cancel();
    if (playBtn) playBtn.classList.remove('playing');
    setTimeout(playNext, 300);
  }, timeout);

  const cleanup = () => { clearInterval(resumeTimer); clearTimeout(watchdog); if (playBtn) playBtn.classList.remove('playing'); };
  u.onend  = () => { cleanup(); setTimeout(playNext, 400); };
  u.onerror = () => { cleanup(); setTimeout(playNext, 200); };
  window.speechSynthesis.speak(u);
}

function speakOne(code, speechCode) {
  stopTTS();
  const el   = document.getElementById(`text-${code}`);
  if (!el) return;
  const text = el.dataset.translated || el.textContent;
  if (!text || el.classList.contains('loading') || el.classList.contains('err-text')) return;
  autoPlay([{ code, speech: speechCode, text }]);
}

function copyOne(code) {
  const el   = document.getElementById(`text-${code}`);
  const text = el.dataset.translated || el.textContent;
  if (!text) return;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById(`copy-${code}`);
    btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'; btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; btn.classList.remove('copied'); }, 2000);
  }).catch(() => {
    showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ‚Äî —É–¥–µ—Ä–∂–∏ —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä—É—á–Ω—É—é.');
    setTimeout(hideError, 3000);
  });
}

/* ============================================================
   –ê–í–¢–û-–†–ï–ñ–ò–ú
============================================================ */
function setAutoMode(btn) {
  autoMode = btn.dataset.auto;
  localStorage.setItem('autoMode', autoMode);
  document.querySelectorAll('.auto-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const labels = { off: '—Ä—É—á–Ω–æ–π', repeat: '–∞–≤—Ç–æ-–∑–∞–ø–∏—Å—å', dialog: '–¥–∏–∞–ª–æ–≥' };
  document.getElementById('autoModeLabel').textContent = labels[autoMode] || '';
}

function scheduleAutoRestart() {
  if (autoMode === 'off') return;
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –∫–æ–º—É –≥–æ–≤–æ—Ä–∏—Ç—å –≤–æ –≤—Ä–µ–º—è –ø–∞—É–∑—ã
  const hint = document.getElementById('recordHint');
  if (autoMode === 'dialog') {
    hint.textContent = mode === 'ru' ? '–•–æ–¥ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...' : '–í–∞—à —Ö–æ–¥...';
  } else {
    hint.textContent = '–ì–æ–≤–æ—Ä–∏—Ç–µ —Å–Ω–æ–≤–∞...';
  }
  hint.classList.add('live');
  autoRestartTimer = setTimeout(() => {
    autoRestartTimer = null;
    if (autoMode === 'dialog') {
      const next = mode === 'ru' ? 'foreign' : 'ru';
      mode = next;
      localStorage.setItem('mode', next);
      document.getElementById('tab-ru').classList.toggle('active', next === 'ru');
      document.getElementById('tab-foreign').classList.toggle('active', next === 'foreign');
      document.getElementById('langPillsLabel').textContent =
        next === 'ru' ? '–ù–∞ –∫–∞–∫–æ–π —è–∑—ã–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å:' : '–Ø–∑—ã–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:';
      updateSubtitle();
    }
    navigator.vibrate && navigator.vibrate([40, 60, 40]);
    startRecording();
  }, 700);
}

/* ============================================================
   TTS –°–ö–û–†–û–°–¢–¨
============================================================ */
function setTtsRate(btn) {
  ttsRate = parseFloat(btn.dataset.rate);
  localStorage.setItem('ttsRate', ttsRate);
  document.querySelectorAll('.speed-btn:not(.auto-btn)').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

/* ============================================================
   FULLSCREEN ‚Äî —Ä–µ–∂–∏–º "–ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É"
============================================================ */
function showFullscreen(code) {
  const el = document.getElementById(`text-${code}`);
  if (!el || el.classList.contains('loading') || el.classList.contains('err-text')) return;
  const text   = el.dataset.translated || el.textContent;
  const dir    = el.getAttribute('dir') || 'ltr';
  const speech = el.dataset.speech || '';
  const lang   = ALL_LANGS.find(l => l.code === code);

  document.getElementById('fsText').textContent = text;
  document.getElementById('fsText').setAttribute('dir', dir);
  document.getElementById('fsLang').textContent = lang ? `${lang.flag} ${lang.name}` : '';
  document.getElementById('fsOverlay').style.display = 'flex';

  document.documentElement.requestFullscreen && document.documentElement.requestFullscreen().catch(() => {});
  if (speech) speakOne(code, speech);
}

function closeFullscreen() {
  document.getElementById('fsOverlay').style.display = 'none';
  if (document.fullscreenElement) document.exitFullscreen().catch(() => {});
  stopTTS();
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeFullscreen(); });
// Android: —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ fullscreen –±–µ–∑ Escape
document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement) {
    const ov = document.getElementById('fsOverlay');
    if (ov && ov.style.display !== 'none') { ov.style.display = 'none'; stopTTS(); }
  }
});

/* ============================================================
   –ò–°–¢–û–†–ò–Ø ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–µ—Ä–µ–≤–æ–¥—ã, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –ë–ï–ó API
============================================================ */
function getHistory() {
  try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; }
  catch { return []; }
}

function saveHistory(text, fromCode, successTexts) {
  const history = getHistory();
  if (history.length && history[0].text === text) return;
  history.unshift({
    id: Date.now(), text, fromCode, mode,
    foreignLang, foreignCode,
    ts: new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' }),
    translations: successTexts.map(t => ({ code: t.code, speech: t.speech, text: t.text, roman: t.roman || null })),
  });
  if (history.length > 50) history.pop();
  try { localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); } catch { /* storage full */ }
  if (histOpen) renderHistory();
}

function toggleHistory() {
  histOpen = !histOpen;
  document.getElementById('historyBody').style.display = histOpen ? 'block' : 'none';
  document.getElementById('histToggleIcon').classList.toggle('open', histOpen);
  if (histOpen) renderHistory();
}

function renderHistory() {
  const list    = document.getElementById('historyList');
  const history = getHistory();
  list.innerHTML = '';

  if (!history.length) {
    const empty = document.createElement('div');
    empty.className = 'history-empty'; empty.textContent = '–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞';
    list.appendChild(empty); return;
  }

  history.forEach(h => {
    const fromLang = ALL_LANGS.find(l => l.code === h.fromCode);
    const item = document.createElement('div');
    item.className = 'history-item';

    const flag = document.createElement('span');
    flag.className   = 'history-flag';
    flag.textContent = fromLang ? fromLang.flag : 'üåê';

    const textEl = document.createElement('span');
    textEl.className   = 'history-text';
    textEl.textContent = h.text;

    const langsEl = document.createElement('span');
    langsEl.className   = 'history-langs';
    langsEl.textContent = h.translations
      ? '‚Üí ' + h.translations.map(t => { const l = ALL_LANGS.find(x => x.code === t.code); return l ? l.flag : ''; }).join('')
      : '';

    const tsEl = document.createElement('span');
    tsEl.className   = 'history-ts';
    tsEl.textContent = h.ts;

    const delBtn = document.createElement('button');
    delBtn.className   = 'history-del';
    delBtn.textContent = '‚úï';
    delBtn.title       = '–£–¥–∞–ª–∏—Ç—å';
    delBtn.onclick     = (e) => { e.stopPropagation(); deleteHistoryItem(h.id); };

    item.appendChild(flag); item.appendChild(textEl); item.appendChild(langsEl); item.appendChild(tsEl); item.appendChild(delBtn);
    item.onclick = () => replayFromHistory(h);
    list.appendChild(item);
  });

  const clearBtn = document.createElement('button');
  clearBtn.className   = 'history-clear-btn';
  clearBtn.textContent = 'üóë –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é';
  clearBtn.onclick     = () => { localStorage.removeItem(HISTORY_KEY); renderHistory(); };
  list.appendChild(clearBtn);
}

/* ============================================================
   –í–´–ë–û–† –Ø–ó–´–ö–ê ‚Äî –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
============================================================ */
function showLangModal() {
  const grid = document.getElementById('langModalGrid');
  grid.innerHTML = '';
  OTHER_LANGS.forEach(lang => {
    const btn = document.createElement('button');
    btn.className   = 'lang-modal-item';
    btn.textContent = `${lang.flag} ${lang.name}`;
    btn.onclick     = () => selectOtherLang(lang);
    grid.appendChild(btn);
  });
  document.getElementById('langModalOverlay').classList.add('open');
}

function hideLangModal() {
  document.getElementById('langModalOverlay').classList.remove('open');
}

function selectOtherLang(lang) {
  hideLangModal();
  // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–µ—Ç–æ–∫
  document.querySelectorAll('.lang-pill').forEach(b => b.classList.remove('active'));
  // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–î—Ä—É–≥–æ–π" —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫
  const pill = document.getElementById('otherLangPill');
  pill.textContent   = `${lang.flag} ${lang.name}`;
  pill.dataset.lang  = lang.speech;
  pill.dataset.code  = lang.code;
  pill.classList.add('active');
  foreignLang = lang.speech;
  foreignCode = lang.code;
  localStorage.setItem('foreignLang', foreignLang);
  localStorage.setItem('foreignCode', foreignCode);
  updateSubtitle();
}

function deleteHistoryItem(id) {
  const history = getHistory().filter(h => h.id !== id);
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
  renderHistory();
}

function replayFromHistory(h) {
  const targetMode = h.mode || 'ru';
  if (targetMode !== mode) {
    mode = targetMode;
    document.getElementById('tab-ru').classList.toggle('active', mode === 'ru');
    document.getElementById('tab-foreign').classList.toggle('active', mode === 'foreign');
    document.getElementById('langPillsLabel').textContent =
      mode === 'ru' ? '–ù–∞ –∫–∞–∫–æ–π —è–∑—ã–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å:' : '–Ø–∑—ã–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:';
  }
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫
  if (h.foreignCode) {
    foreignLang = h.foreignLang || foreignLang;
    foreignCode = h.foreignCode || foreignCode;
    document.querySelectorAll('.lang-pill').forEach(b => {
      b.classList.toggle('active', b.dataset.code === foreignCode);
    });
  }

  hideError(); resetUI();

  if (h.translations && h.translations.length) {
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ‚Äî API –Ω–µ –Ω—É–∂–µ–Ω
    const successTexts = displaySavedTranslations(h.text, h.fromCode, targetMode, h.translations);
    if (successTexts.length) autoPlay(successTexts);
  } else {
    // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤ ‚Äî –ø–µ—Ä–µ–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º
    document.getElementById('recognizedCard').style.display = 'block';
    const rbox = document.getElementById('recognizedBox');
    rbox.textContent = h.text; rbox.classList.remove('empty');
    doTranslate(h.text, h.fromCode);
  }
}

/* ============================================================
   –°–ß–Å–¢–ß–ò–ö –ó–ê–ü–†–û–°–û–í API (Groq free: 14 400 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å)
============================================================ */
function trackApiWords(text, numTargets) {
  const day = new Date().toISOString().slice(0, 10); // 'YYYY-MM-DD'
  let stored;
  try { stored = JSON.parse(localStorage.getItem(CHARS_KEY) || '{}'); }
  catch { stored = {}; }
  const prev     = stored.day === day ? (stored.count || 0) : 0;
  const newCount = prev + numTargets;
  try { localStorage.setItem(CHARS_KEY, JSON.stringify({ day, count: newCount })); } catch {}
  renderWordCounter(newCount);
}

function renderWordCounter(count) {
  const el = document.getElementById('wordCounter');
  if (!el) return;
  const limit = 14_400;
  const pct   = count / limit;
  if (pct < 0.75) { el.textContent = ''; return; }
  el.textContent = `‚ö†Ô∏è –õ–∏–º–∏—Ç Groq: ${count} / ${limit} –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è`;
  el.className   = 'word-counter' + (pct >= 0.9 ? ' danger' : ' warn');
}

/* ============================================================
   –ü–†–û–í–ï–†–ö–ê TTS-–ì–û–õ–û–°–û–í
============================================================ */
function checkTTSVoices() {
  const voices = window.speechSynthesis.getVoices();
  if (!voices.length) return; // –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —è–∑—ã–∫–∏ –∏–∑ ALL_RU_TARGETS + —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π
  const toCheck = ALL_RU_TARGETS.filter(l => l.code !== 'en'); // English –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å
  const missing = toCheck.filter(lang => {
    const prefix = lang.speech.split('-')[0];
    return !voices.some(v => v.lang === lang.speech || v.lang.startsWith(prefix));
  });

  const el = document.getElementById('ttsWarn');
  if (!el) return;
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫ –∏–ª–∏ –±–∞–∑–æ–≤—ã–µ (ar, tr)
  const relevantMissing = missing.filter(l =>
    l.code === foreignCode || l.code === 'ar' || l.code === 'tr'
  );
  if (relevantMissing.length) {
    el.textContent = `üîá –ù–µ—Ç TTS-–≥–æ–ª–æ—Å–∞ –¥–ª—è: ${relevantMissing.map(l => l.name).join(', ')}. –£—Å—Ç–∞–Ω–æ–≤–∏ —è–∑—ã–∫–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã: Android ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å ‚Üí –°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏.`;
    el.classList.add('visible');
  } else {
    el.classList.remove('visible');
  }
}

/* ============================================================
   –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø –°–ï–¢–ò
============================================================ */
function updateOnlineStatus() {
  const offline = !navigator.onLine;
  document.getElementById('offlineWarn').classList.toggle('visible', offline);
}
window.addEventListener('online',  updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

/* ============================================================
   WAKE LOCK ‚Äî —ç–∫—Ä–∞–Ω –Ω–µ –≥–∞—Å–Ω–µ—Ç
============================================================ */
async function requestWakeLock() {
  if (!('wakeLock' in navigator)) return;
  try {
    wakeLock = await navigator.wakeLock.request('screen');
    wakeLock.addEventListener('release', () => { wakeLock = null; });
  } catch(e) {}
}
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') requestWakeLock();
});
requestWakeLock();

/* ============================================================
   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ì–û–õ–û–°–û–í
============================================================ */
if (window.speechSynthesis) {
  window.speechSynthesis.onvoiceschanged = () => {
    window.speechSynthesis.getVoices();
    checkTTSVoices();
  };
  window.speechSynthesis.getVoices();
  // –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç –≥–æ–ª–æ—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–∞–∑—É
  setTimeout(checkTTSVoices, 500);
}

/* ============================================================
   –ü–†–û–í–ï–†–ö–ê –ë–†–ê–£–ó–ï–†–ê
============================================================ */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SR) {
  document.getElementById('browserWarn').classList.add('visible');
}

/* ============================================================
   SERVICE WORKER (PWA)
============================================================ */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  });
}

/* ============================================================
   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø UI
============================================================ */
(function init() {
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É (—Ä–µ–∂–∏–º)
  const savedMode = localStorage.getItem('mode') || 'ru';
  if (savedMode !== 'ru') {
    mode = savedMode;
    document.getElementById('tab-ru').classList.remove('active');
    document.getElementById('tab-foreign').classList.add('active');
    document.getElementById('langPillsLabel').textContent = '–Ø–∑—ã–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:';
  }

  // –ê–≤—Ç–æ-—Ä–µ–∂–∏–º
  const savedAutoMode = localStorage.getItem('autoMode') || 'off';
  autoMode = savedAutoMode;
  document.querySelectorAll('.auto-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.auto === savedAutoMode);
  });
  const autoLabels = { off: '—Ä—É—á–Ω–æ–π', repeat: '–∞–≤—Ç–æ-–∑–∞–ø–∏—Å—å', dialog: '–¥–∏–∞–ª–æ–≥' };
  document.getElementById('autoModeLabel').textContent = autoLabels[savedAutoMode] || '—Ä—É—á–Ω–æ–π';

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫
  const savedForeignLang = localStorage.getItem('foreignLang');
  const savedForeignCode = localStorage.getItem('foreignCode');
  if (savedForeignLang && savedForeignCode) {
    foreignLang = savedForeignLang;
    foreignCode = savedForeignCode;
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º ‚Äî –º–æ–∂–µ—Ç —ç—Ç–æ –∫–∞—Å—Ç–æ–º–Ω—ã–π —è–∑—ã–∫ (–Ω–µ –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–µ—Ç–∫–∞—Ö)
    const isCore = TARGETS.ru.some(l => l.code === savedForeignCode);
    if (isCore) {
      document.querySelectorAll('.lang-pill').forEach(b => {
        b.classList.toggle('active', b.dataset.code === foreignCode);
      });
    } else {
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π —è–∑—ã–∫ –≤ –∫–Ω–æ–ø–∫–µ "–î—Ä—É–≥–æ–π"
      const lang = OTHER_LANGS.find(l => l.code === savedForeignCode);
      if (lang) {
        document.querySelectorAll('.lang-pill').forEach(b => b.classList.remove('active'));
        const pill = document.getElementById('otherLangPill');
        pill.textContent  = `${lang.flag} ${lang.name}`;
        pill.dataset.lang = lang.speech;
        pill.dataset.code = lang.code;
        pill.classList.add('active');
      }
    }
  }
  updateSubtitle();

  // TTS —Å–∫–æ—Ä–æ—Å—Ç—å
  const savedRate = parseFloat(localStorage.getItem('ttsRate') || '0.88');
  ttsRate = savedRate;
  document.querySelectorAll('.speed-btn:not(.auto-btn)').forEach(btn => {
    btn.classList.toggle('active', Math.abs(parseFloat(btn.dataset.rate) - savedRate) < 0.01);
  });

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∏
  updateOnlineStatus();

  // –°—á—ë—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ Groq
  const today = new Date().toISOString().slice(0, 10);
  try {
    const stored = JSON.parse(localStorage.getItem(CHARS_KEY) || '{}');
    renderWordCounter(stored.day === today ? (stored.count || 0) : 0);
  } catch { renderWordCounter(0); }

  // –ù–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  translateStyle = localStorage.getItem('translateStyle') || 'casual';
  document.getElementById('tone-casual').classList.toggle('active', translateStyle === 'casual');
  document.getElementById('tone-formal').classList.toggle('active', translateStyle === 'formal');

  ttsVolume = parseFloat(localStorage.getItem('ttsVolume') || '1');
  const volSlider = document.getElementById('volumeSlider');
  if (volSlider) volSlider.value = ttsVolume;

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç-–¥–∏–∞–ª–æ–≥–∞
  restoreChatHistory();

  // –û–Ω–±–æ—Ä–¥–∏–Ω–≥ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
  showOnboarding();

  // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
  refreshFavCard();
})();

/* ============================================================
   SWAP MODES
============================================================ */
function swapModes() {
  setMode(mode === 'ru' ? 'foreign' : 'ru');
}

/* ============================================================
   –°–¢–ò–õ–¨ –ü–ï–†–ï–í–û–î–ê (—Ç–æ–Ω)
============================================================ */
function setTone(tone) {
  translateStyle = tone;
  localStorage.setItem('translateStyle', tone);
  document.getElementById('tone-casual').classList.toggle('active', tone === 'casual');
  document.getElementById('tone-formal').classList.toggle('active', tone === 'formal');
}

/* ============================================================
   –ì–†–û–ú–ö–û–°–¢–¨ TTS
============================================================ */
function setVolume(v) {
  ttsVolume = parseFloat(v);
  localStorage.setItem('ttsVolume', ttsVolume);
}

/* ============================================================
   –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –†–ê–°–ü–û–ó–ù–ê–ù–ù–û–ì–û –¢–ï–ö–°–¢–ê
============================================================ */
function onRecognizedEdit() {
  const box = document.getElementById('recognizedBox');
  const btn = document.getElementById('retranslateBtn');
  if (!box || !btn) return;
  btn.classList.toggle('show', (box.textContent || '').trim().length > 0);
}
function retranslateEdited() {
  const box = document.getElementById('recognizedBox');
  if (!box) return;
  const text = (box.textContent || '').trim();
  if (!text) return;
  if (document.getElementById('micBtn').classList.contains('busy')) return;
  box.classList.remove('empty');
  doTranslate(text, getInputCode(), true);
}

/* ============================================================
   –ò–ó–ë–†–ê–ù–ù–û–ï
============================================================ */
function getFavorites() {
  try { return JSON.parse(localStorage.getItem(FAVORITES_KEY)) || []; }
  catch { return []; }
}
function toggleFavorite(code) {
  const el = document.getElementById(`text-${code}`);
  if (!el) return;
  const text = el.dataset.translated || el.textContent;
  const lang = ALL_LANGS.find(l => l.code === code);
  const srcEl = document.getElementById('recognizedBox');
  const srcText = srcEl ? (srcEl.textContent || '').trim() : '';
  const favorites = getFavorites();
  const existing = favorites.findIndex(f => f.code === code && f.text === text);
  const btn = document.getElementById(`fav-${code}`);
  if (existing >= 0) {
    favorites.splice(existing, 1);
    if (btn) { btn.textContent = '‚òÜ'; btn.classList.remove('starred'); }
  } else {
    favorites.unshift({ id: Date.now(), code, text, srcText, langLabel: lang ? `${lang.flag} ${lang.name}` : code,
      ts: new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' }) });
    if (favorites.length > 50) favorites.pop();
    if (btn) { btn.textContent = '‚òÖ'; btn.classList.add('starred'); }
  }
  try { localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites)); } catch {}
  refreshFavCard();
}
function refreshFavCard() {
  const favs = getFavorites();
  const card = document.getElementById('favCard');
  if (card) card.style.display = favs.length ? 'block' : 'none';
  if (favOpen) renderFavorites();
}
function toggleFavSection() {
  favOpen = !favOpen;
  document.getElementById('favBody').style.display = favOpen ? 'block' : 'none';
  document.getElementById('favToggleIcon').classList.toggle('open', favOpen);
  if (favOpen) renderFavorites();
}
function renderFavorites() {
  const list  = document.getElementById('favList');
  const favs  = getFavorites();
  list.innerHTML = '';
  if (!favs.length) { list.innerHTML = '<div class="history-empty">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö</div>'; return; }
  favs.forEach(f => {
    const item = document.createElement('div');
    item.className = 'fav-item';
    item.innerHTML = `
      <span style="font-size:0.8rem;flex-shrink:0">${escapeHtml(f.langLabel || '')}</span>
      <span class="fav-item-text">${escapeHtml(f.text || '')}</span>
      <button class="fav-item-del" title="–£–¥–∞–ª–∏—Ç—å" onclick="event.stopPropagation();removeFavorite(${Number(f.id)})">‚úï</button>`;
    item.onclick = () => speakFavorite(f);
    list.appendChild(item);
  });
}
function removeFavorite(id) {
  const favs = getFavorites().filter(f => f.id !== id);
  try { localStorage.setItem(FAVORITES_KEY, JSON.stringify(favs)); } catch {}
  refreshFavCard();
}
function speakFavorite(f) {
  const lang = ALL_LANGS.find(l => l.code === f.code);
  if (!lang) return;
  stopTTS();
  autoPlay([{ code: f.code, speech: lang.speech, text: f.text }]);
}

/* ============================================================
   –§–†–ê–ó–û–í–ù–ò–ö
============================================================ */
const PHRASES = {
  '‚úàÔ∏è –ê—ç—Ä–æ–ø–æ—Ä—Ç': [
    '–ì–¥–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —Ä–µ–π—Å?','–ì–¥–µ –≤—ã—Ö–æ–¥ –Ω–∞ –ø–æ—Å–∞–¥–∫—É?','–ú–æ–π —Ä–µ–π—Å –∑–∞–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è',
    '–ì–¥–µ –∑–∞–±—Ä–∞—Ç—å –±–∞–≥–∞–∂?','–Ø –ø–æ—Ç–µ—Ä—è–ª –±–∞–≥–∞–∂','–ì–¥–µ –ø–∞—Å–ø–æ—Ä—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å?',
    '–£ –º–µ–Ω—è –ø–µ—Ä–µ—Å–∞–¥–∫–∞','–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Ç–∞–∫—Å–∏ –¥–æ –≥–æ—Ä–æ–¥–∞?',
  ],
  'üè® –û—Ç–µ–ª—å': [
    '–Ø –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª –Ω–æ–º–µ—Ä','–ö–æ–≥–¥–∞ –º–æ–∂–Ω–æ –∑–∞—Å–µ–ª–∏—Ç—å—Å—è?','–ú–æ–∂–Ω–æ –ø–æ–∑–¥–Ω–æ –≤—ã–µ—Ö–∞—Ç—å?',
    '–ì–¥–µ –ª–∏—Ñ—Ç?','–ú–Ω–µ –Ω—É–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–æ—Ç–µ–Ω—Ü–µ','–ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç',
    '–ö–æ–≥–¥–∞ –∑–∞–≤—Ç—Ä–∞–∫?','–í—ã–∑–æ–≤–∏—Ç–µ —Ç–∞–∫—Å–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞',
  ],
  'üçΩÔ∏è –†–µ—Å—Ç–æ—Ä–∞–Ω': [
    '–°—Ç–æ–ª–∏–∫ –Ω–∞ –¥–≤–æ–∏—Ö, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞','–ú–µ–Ω—é, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞','–ß—Ç–æ –≤—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç–µ?',
    '–Ø –≤–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω–µ—Ü','–ë–µ–∑ –æ—Ä–µ—Ö–æ–≤, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞','–°—á—ë—Ç, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞',
    '–≠—Ç–æ –æ—á–µ–Ω—å –≤–∫—É—Å–Ω–æ','–ú–æ–∂–Ω–æ –≤–æ–¥—ã?',
  ],
  'üöï –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç': [
    '–û—Ç–≤–µ–∑–∏—Ç–µ –º–µ–Ω—è –≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç','–û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–¥–µ—Å—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞','–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –ø–æ–µ–∑–¥–∫–∞?',
    '–ì–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–±—É—Å–∞?','–ì–¥–µ –º–µ—Ç—Ä–æ?','–ö–∞–∫ –¥–æ–µ—Ö–∞—Ç—å –¥–æ —Ü–µ–Ω—Ç—Ä–∞?',
    '–í—ã–∑–æ–≤–∏—Ç–µ —Ç–∞–∫—Å–∏','–ú–Ω–µ –Ω—É–∂–Ω–æ –Ω–∞ –≤–æ–∫–∑–∞–ª',
  ],
  'üõí –ü–æ–∫—É–ø–∫–∏': [
    '–°–∫–æ–ª—å–∫–æ —ç—Ç–æ —Å—Ç–æ–∏—Ç?','–î–æ—Ä–æ–≥–æ. –ú–æ–∂–Ω–æ –¥–µ—à–µ–≤–ª–µ?','–Ø –ø—Ä–æ—Å—Ç–æ —Å–º–æ—Ç—Ä—é',
    '–ï—Å—Ç—å —Ä–∞–∑–º–µ—Ä –º–µ–Ω—å—à–µ?','–ì–¥–µ –ø—Ä–∏–º–µ—Ä–æ—á–Ω–∞—è?','–Ø –≤–æ–∑—å–º—É —ç—Ç–æ',
    '–ú–æ–∂–Ω–æ –∫–∞—Ä—Ç–æ—á–∫–æ–π?','–ï—Å—Ç—å —Å–∫–∏–¥–∫–∞?',
  ],
  'üö® –ü–æ–º–æ—â—å': [
    '–í—ã–∑–æ–≤–∏—Ç–µ —Å–∫–æ—Ä—É—é –ø–æ–º–æ—â—å','–í—ã–∑–æ–≤–∏—Ç–µ –ø–æ–ª–∏—Ü–∏—é','–ú–Ω–µ –ø–ª–æ—Ö–æ',
    '–Ø –ø–æ—Ç–µ—Ä—è–ª—Å—è','–ú–µ–Ω—è –æ–±–æ–∫—Ä–∞–ª–∏','–ì–¥–µ –±–æ–ª—å–Ω–∏—Ü–∞?',
    '–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å','–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –≤ –ø–æ—Å–æ–ª—å—Å—Ç–≤–æ –†–æ—Å—Å–∏–∏',
  ],
};
function togglePhrasebook() {
  phrasebookOpen = !phrasebookOpen;
  document.getElementById('phrasebookBody').style.display = phrasebookOpen ? 'block' : 'none';
  document.getElementById('phraseToggleIcon').classList.toggle('open', phrasebookOpen);
  if (phrasebookOpen && !activePhraseCategory) {
    renderPhraseCategories();
    selectPhraseCategory(Object.keys(PHRASES)[0]);
  }
}
function renderPhraseCategories() {
  const container = document.getElementById('phraseCategories');
  container.innerHTML = '';
  const cats = [...Object.keys(PHRASES)];
  if (getCustomPhrases().length) cats.push('‚≠ê –ú–æ–∏ —Ñ—Ä–∞–∑—ã');
  cats.forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'phrase-cat-btn' + (cat === activePhraseCategory ? ' active' : '');
    btn.textContent = cat;
    btn.onclick = () => selectPhraseCategory(cat);
    container.appendChild(btn);
  });
}
function getPhrasesByCategory(cat) {
  if (cat === '‚≠ê –ú–æ–∏ —Ñ—Ä–∞–∑—ã') return getCustomPhrases();
  return PHRASES[cat] || [];
}
function selectPhraseCategory(cat) {
  activePhraseCategory = cat;
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ–∏—Å–∫–∞
  const searchEl = document.getElementById('phraseSearch');
  if (searchEl) searchEl.value = '';
  document.querySelectorAll('.phrase-cat-btn').forEach(b => {
    b.classList.toggle('active', b.textContent === cat);
  });
  const list     = document.getElementById('phraseList');
  list.innerHTML = '';
  const isCustom = cat === '‚≠ê –ú–æ–∏ —Ñ—Ä–∞–∑—ã';
  const phrases  = getPhrasesByCategory(cat);
  if (!phrases.length) {
    list.innerHTML = isCustom
      ? '<div class="history-empty">–ù–∞–∂–º–∏—Ç–µ ¬´Ôºã –î–æ–±–∞–≤–∏—Ç—å¬ª, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–≤–æ–∏ —Ñ—Ä–∞–∑—ã</div>'
      : '<div class="history-empty">–ù–µ—Ç —Ñ—Ä–∞–∑</div>';
    return;
  }
  phrases.forEach(phrase => {
    if (isCustom) {
      const row = document.createElement('div');
      row.style.cssText = 'display:flex;gap:6px;align-items:center;margin-bottom:4px';
      const btn = document.createElement('button');
      btn.className = 'phrase-item'; btn.style.flex = '1'; btn.style.margin = '0';
      btn.textContent = phrase;
      btn.onclick = () => sendPhrase(phrase);
      const del = document.createElement('button');
      del.className = 'history-del'; del.textContent = '‚úï'; del.title = '–£–¥–∞–ª–∏—Ç—å';
      del.onclick = () => removeCustomPhrase(phrase);
      row.appendChild(btn); row.appendChild(del);
      list.appendChild(row);
    } else {
      const btn = document.createElement('button');
      btn.className = 'phrase-item';
      btn.textContent = phrase;
      btn.onclick = () => sendPhrase(phrase);
      list.appendChild(btn);
    }
  });
}
function getCustomPhrases() {
  try { return JSON.parse(localStorage.getItem(CUSTOM_PHRASES_KEY) || '[]'); }
  catch { return []; }
}
function addCustomPhrase(phrase) {
  const phrases = getCustomPhrases();
  if (phrases.includes(phrase)) return;
  phrases.unshift(phrase);
  if (phrases.length > 30) phrases.pop();
  try { localStorage.setItem(CUSTOM_PHRASES_KEY, JSON.stringify(phrases)); } catch {}
  renderPhraseCategories();
  selectPhraseCategory('‚≠ê –ú–æ–∏ —Ñ—Ä–∞–∑—ã');
}
function removeCustomPhrase(phrase) {
  const phrases = getCustomPhrases().filter(p => p !== phrase);
  try { localStorage.setItem(CUSTOM_PHRASES_KEY, JSON.stringify(phrases)); } catch {}
  renderPhraseCategories();
  selectPhraseCategory('‚≠ê –ú–æ–∏ —Ñ—Ä–∞–∑—ã');
}
function promptAddPhrase() {
  const phrase = prompt('–í–≤–µ–¥–∏—Ç–µ —Ñ—Ä–∞–∑—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:');
  if (phrase && phrase.trim()) {
    if (!phrasebookOpen) togglePhrasebook();
    addCustomPhrase(phrase.trim());
  }
}
function filterPhrases(query) {
  const q    = query.trim().toLowerCase();
  const list = document.getElementById('phraseList');
  if (!q) { if (activePhraseCategory) selectPhraseCategory(activePhraseCategory); return; }
  list.innerHTML = '';
  const all     = [...Object.values(PHRASES).flat(), ...getCustomPhrases()];
  const matched = all.filter(p => p.toLowerCase().includes(q));
  if (!matched.length) { list.innerHTML = '<div class="history-empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
  matched.forEach(phrase => {
    const btn = document.createElement('button');
    btn.className = 'phrase-item';
    btn.textContent = phrase;
    btn.onclick = () => sendPhrase(phrase);
    list.appendChild(btn);
  });
}
function sendPhrase(phrase) {
  hideError(); resetUI();
  document.getElementById('recognizedCard').style.display = 'block';
  const rbox = document.getElementById('recognizedBox');
  rbox.textContent = phrase; rbox.classList.remove('empty');
  doTranslate(phrase, 'ru', true);
  setTimeout(() => {
    document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 300);
}

/* ============================================================
   –ß–ê–¢-–î–ò–ê–õ–û–ì
============================================================ */
function getChatHistory() {
  try { return JSON.parse(localStorage.getItem(CHAT_KEY) || '[]'); }
  catch { return []; }
}
function saveChatMessage(data) {
  const chat = getChatHistory();
  chat.push(data);
  if (chat.length > 50) chat.shift();
  try { localStorage.setItem(CHAT_KEY, JSON.stringify(chat)); } catch {}
}
function restoreChatHistory() {
  const chat = getChatHistory();
  if (!chat.length) return;
  chat.forEach(m => appendChatBubble(m.origText, m.origCode, m.translText, m.translCode, m.roman, true));
}

function appendChatBubble(origText, origCode, translText, translCode, roman, skipSave = false) {
  const chatCard = document.getElementById('chatCard');
  const chatView = document.getElementById('chatView');
  if (!chatCard || !chatView) return;
  chatCard.style.display = 'block';
  if (!skipSave) saveChatMessage({ origText, origCode, translText, translCode, roman });
  const isUser = (origCode === 'ru');
  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble ' + (isUser ? 'user' : 'partner');
  const origLang = ALL_LANGS.find(l => l.code === origCode);
  const trLang   = ALL_LANGS.find(l => l.code === translCode);
  bubble.innerHTML = `
    <div class="chat-bubble-lang">${origLang ? origLang.flag : ''} ${origLang ? origLang.name : origCode}</div>
    <div class="chat-bubble-text">${escapeHtml(origText)}</div>
    ${translText ? `<div class="chat-bubble-lang" style="margin-top:6px">${trLang ? trLang.flag : ''} ${trLang ? trLang.name : translCode}</div>
    <div class="chat-bubble-text" style="font-style:italic;opacity:0.9">${escapeHtml(translText)}</div>` : ''}
    ${roman ? `<div class="chat-bubble-translit">${escapeHtml(roman)}</div>` : ''}`;
  chatView.appendChild(bubble);
  bubble.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
function clearChat() {
  const chatView = document.getElementById('chatView');
  const chatCard = document.getElementById('chatCard');
  if (chatView) chatView.innerHTML = '';
  if (chatCard) chatCard.style.display = 'none';
  try { localStorage.removeItem(CHAT_KEY); } catch {}
}
function escapeHtml(t) {
  if (!t) return '';
  return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ============================================================
   –û–ù–ë–û–†–î–ò–ù–ì
============================================================ */
const ONBOARD_STEPS = [
  { icon: 'üåê', title: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!',  text: 'LinguaVox ‚Äî –∫–∞—Ä–º–∞–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ —Å –ò–ò Groq (Llama 3.3). –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Å—Ç–∏–ª—å, –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥, —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è—Ö.' },
  { icon: 'üé§', title: '–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥',      text: '–ù–∞–∂–º–∏—Ç–µ üé§ –∏ –≥–æ–≤–æ—Ä–∏—Ç–µ –ø–æ-—Ä—É—Å—Å–∫–∏. –ü–µ—Ä–µ–≤–æ–¥ –ø–æ—è–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É. –ü–æ–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É.' },
  { icon: 'üí¨', title: '–†–µ–∂–∏–º –¥–∏–∞–ª–æ–≥–∞',       text: '–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º üí¨ ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —Å–∞–º–æ —á–µ—Ä–µ–¥–æ–≤–∞—Ç—å –≤–∞—Å –∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞. –ù–µ –Ω—É–∂–Ω–æ –Ω–∞–∂–∏–º–∞—Ç—å –∫–Ω–æ–ø–∫–∏!' },
  { icon: 'üìö', title: '–§—Ä–∞–∑–æ–≤–Ω–∏–∫',           text: '–ù–µ –∑–Ω–∞–µ—Ç–µ –∫–∞–∫ –Ω–∞—á–∞—Ç—å? –í —Ñ—Ä–∞–∑–æ–≤–Ω–∏–∫–µ ‚Äî –≥–æ—Ç–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞, –≥–æ—Å—Ç–∏–Ω–∏—Ü—ã –∏ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤.' },
  { icon: '‚úÖ', title: '–í—Å—ë –≥–æ—Ç–æ–≤–æ!',         text: '–î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω (Android: –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞ ‚Üí ¬´–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω¬ª). –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ!' },
];
function showOnboarding() {
  if (localStorage.getItem('onboardDone')) return;
  const overlay = document.getElementById('onboardOverlay');
  if (!overlay) return;
  onboardStep = 0;
  overlay.classList.remove('hidden');
  renderOnboardStep();
}
function renderOnboardStep() {
  const step = ONBOARD_STEPS[onboardStep];
  document.getElementById('onboardIcon').textContent  = step.icon;
  document.getElementById('onboardTitle').textContent = step.title;
  document.getElementById('onboardText').textContent  = step.text;
  document.getElementById('onboardBtn').textContent   = onboardStep < ONBOARD_STEPS.length - 1 ? '–î–∞–ª–µ–µ ‚Üí' : 'üöÄ –ù–∞—á–∞—Ç—å!';
  const dots = document.getElementById('onboardDots');
  dots.innerHTML = '';
  ONBOARD_STEPS.forEach((_, i) => {
    const dot = document.createElement('div');
    dot.className = 'onboard-dot' + (i === onboardStep ? ' active' : '');
    dots.appendChild(dot);
  });
}
function onboardNext() {
  if (onboardStep < ONBOARD_STEPS.length - 1) { onboardStep++; renderOnboardStep(); }
  else closeOnboarding();
}
function closeOnboarding() {
  localStorage.setItem('onboardDone', '1');
  const overlay = document.getElementById('onboardOverlay');
  if (overlay) overlay.classList.add('hidden');
}
</script>
</body>
</html>
