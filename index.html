<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="theme-color" content="#667eea" id="themeColorMeta">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
  <title>LinguaVox ‚Äî –ì–æ–ª–æ—Å–æ–≤–æ–π –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫</title>
  <style>
    /* ===================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –¢–ï–ú ===================== */
    :root {
      --bg:           #0f0f1a;
      --bg2:          #1a1a2e;
      --bg3:          #0d0d17;
      --card:         #1e1e35;
      --border:       #2a2a4a;
      --text:         #e8e8f0;
      --text2:        #a0a0b8;
      --text3:        #666680;
      --accent1:      #667eea;
      --accent2:      #764ba2;
      --accent-rgb:   102, 126, 234;
      --danger:       #ff4d4d;
      --danger-rgb:   255, 77, 77;
      --success:      #00b894;
      --warn-bg:      rgba(255,170,0,0.10);
      --warn-border:  rgba(255,170,0,0.35);
      --warn-text:    #ffaa44;
      --err-bg:       rgba(255,77,77,0.10);
      --err-border:   rgba(255,77,77,0.35);
      --err-text:     #ff8888;
      --shadow:       0 4px 24px rgba(0,0,0,0.4);
      --radius:       16px;
      --radius-sm:    10px;
    }
    [data-theme="light"] {
      --bg:           #f0f2f8;
      --bg2:          #e4e8f4;
      --bg3:          #dde2f0;
      --card:         #ffffff;
      --border:       #d0d8ee;
      --text:         #1e2140;
      --text2:        #5a6080;
      --text3:        #9098b8;
      --accent1:      #0984e3;
      --accent2:      #4a90d9;
      --accent-rgb:   9, 132, 227;
      --danger:       #e53935;
      --danger-rgb:   229, 57, 53;
      --success:      #00897b;
      --warn-bg:      rgba(255,152,0,0.10);
      --warn-border:  rgba(255,152,0,0.35);
      --warn-text:    #e67e00;
      --err-bg:       rgba(229,57,53,0.10);
      --err-border:   rgba(229,57,53,0.35);
      --err-text:     #e53935;
      --shadow:       0 4px 24px rgba(0,0,0,0.10);
    }

    /* ===================== –°–ë–†–û–° –ò –ë–ê–ó–ê ===================== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh; display: flex; flex-direction: column;
      align-items: center; padding: 0 0 40px;
      transition: background 0.3s, color 0.3s;
    }

    /* ===================== –®–ê–ü–ö–ê ===================== */
    header {
      width: 100%; background: var(--bg2);
      border-bottom: 1px solid var(--border);
      padding: 14px 20px; display: flex; align-items: center;
      justify-content: space-between;
      position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow);
    }
    .header-title { display: flex; flex-direction: column; }
    .header-title h1 {
      font-size: 1.15rem; font-weight: 700;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; line-height: 1.2;
    }
    .header-title span { font-size: 0.7rem; color: var(--text3); margin-top: 2px; }
    .theme-btn {
      width: 40px; height: 40px; border-radius: 50%;
      border: 1px solid var(--border); background: var(--card);
      color: var(--text2); font-size: 1.1rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.25s; flex-shrink: 0;
    }
    .theme-btn:hover { background: var(--border); }

    /* ===================== –ö–û–ù–¢–ï–ù–¢ ===================== */
    .content {
      width: 100%; max-width: 480px;
      padding: 20px 16px 0; display: flex;
      flex-direction: column; gap: 14px;
    }

    /* ===================== –í–ö–õ–ê–î–ö–ò ===================== */
    .tabs {
      display: flex; background: var(--bg2);
      border-radius: var(--radius); padding: 4px; gap: 4px;
      border: 1px solid var(--border);
    }
    .tab {
      flex: 1; padding: 11px 8px; border: none;
      background: transparent; color: var(--text2);
      border-radius: var(--radius-sm); cursor: pointer;
      font-size: 0.82rem; font-weight: 500;
      transition: all 0.25s; line-height: 1.3; text-align: center;
    }
    .tab.active {
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: #fff; font-weight: 600;
      box-shadow: 0 2px 12px rgba(var(--accent-rgb), 0.4);
    }

    /* ===================== –ö–ê–†–¢–û–ß–ö–ê ===================== */
    .card {
      background: var(--card); border-radius: var(--radius);
      border: 1px solid var(--border); padding: 20px;
      box-shadow: var(--shadow); transition: background 0.3s, border-color 0.3s;
    }
    .card-label {
      font-size: 0.68rem; font-weight: 700; letter-spacing: 1.2px;
      text-transform: uppercase; color: var(--text3); margin-bottom: 14px;
    }

    /* ===================== –í–´–ë–û–† –Ø–ó–´–ö–ê ===================== */
    .lang-pills { display: flex; flex-wrap: wrap; gap: 8px; }
    .lang-pill {
      padding: 8px 16px; border: 2px solid var(--border);
      background: transparent; color: var(--text2); border-radius: 30px;
      cursor: pointer; font-size: 0.82rem; font-weight: 500; transition: all 0.25s;
    }
    .lang-pill.active {
      border-color: var(--accent1); color: var(--accent1);
      background: rgba(var(--accent-rgb), 0.1);
    }

    /* ===================== –ë–õ–û–ö –ó–ê–ü–ò–°–ò ===================== */
    .record-wrap {
      display: flex; flex-direction: column;
      align-items: center; gap: 14px; padding: 10px 0 4px;
    }
    .mic-btn {
      width: 90px; height: 90px; border-radius: 50%; border: none;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: #fff; font-size: 2rem; cursor: pointer;
      box-shadow: 0 6px 28px rgba(var(--accent-rgb), 0.5);
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex; align-items: center; justify-content: center;
      position: relative; -webkit-tap-highlight-color: transparent;
    }
    .mic-btn:active { transform: scale(0.94); }
    .mic-btn.recording {
      background: linear-gradient(135deg, var(--danger), #cc0000);
      box-shadow: 0 6px 28px rgba(var(--danger-rgb), 0.55);
      animation: mic-pulse 1.4s infinite;
    }
    .mic-btn.busy { opacity: 0.5; cursor: not-allowed; }
    @keyframes mic-pulse {
      0%   { box-shadow: 0 6px 28px rgba(var(--danger-rgb), 0.55); }
      50%  { box-shadow: 0 6px 44px rgba(var(--danger-rgb), 0.85), 0 0 0 14px rgba(var(--danger-rgb), 0.10); }
      100% { box-shadow: 0 6px 28px rgba(var(--danger-rgb), 0.55); }
    }
    .record-hint { font-size: 0.82rem; color: var(--text3); text-align: center; }
    .record-hint.live { color: var(--danger); font-weight: 600; }

    /* ===================== –¢–ï–ö–°–¢–û–í–´–ô –í–í–û–î ===================== */
    .text-input-row { display: flex; gap: 8px; margin-top: 4px; }
    .text-input {
      flex: 1; background: var(--bg2); border: 1px solid var(--border);
      border-radius: var(--radius-sm); color: var(--text);
      font-size: 0.9rem; padding: 10px 14px; outline: none;
      transition: border-color 0.25s;
    }
    .text-input:focus { border-color: var(--accent1); }
    .text-input::placeholder { color: var(--text3); }
    .send-btn {
      width: 42px; height: 42px; border-radius: var(--radius-sm);
      border: none; background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: #fff; font-size: 1.1rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; transition: opacity 0.2s;
    }
    .send-btn:active { opacity: 0.8; }

    /* ===================== TTS –°–ö–û–†–û–°–¢–¨ ===================== */
    .controls-row { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
    .controls-label { font-size: 0.7rem; color: var(--text3); }
    .speed-btn {
      width: 30px; height: 30px; border-radius: 50%;
      border: 1px solid var(--border); background: transparent;
      cursor: pointer; font-size: 0.85rem;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; -webkit-tap-highlight-color: transparent;
    }
    .speed-btn.active { background: rgba(var(--accent-rgb), 0.15); border-color: var(--accent1); }

    /* ===================== –†–ê–°–ü–û–ó–ù–ê–ù–û ===================== */
    .recognized-box {
      background: var(--bg2); border: 1px solid var(--border);
      border-radius: var(--radius-sm); padding: 12px 14px;
      font-size: 0.95rem; color: var(--text);
      line-height: 1.6; min-height: 50px; word-break: break-word;
    }
    .recognized-box.empty { color: var(--text3); font-style: italic; }

    /* ===================== –°–û–û–ë–©–ï–ù–ò–Ø ===================== */
    .msg {
      border-radius: var(--radius-sm); padding: 11px 14px;
      font-size: 0.82rem; line-height: 1.5; display: none;
    }
    .msg.warn { background: var(--warn-bg); border: 1px solid var(--warn-border); color: var(--warn-text); }
    .msg.err  { background: var(--err-bg);  border: 1px solid var(--err-border);  color: var(--err-text); }
    .msg.visible { display: block; }

    /* ===================== –ü–ï–†–ï–í–û–î–´ ===================== */
    .translations { display: flex; flex-direction: column; gap: 12px; }
    .tr-card {
      background: var(--bg2); border: 1px solid var(--border);
      border-radius: var(--radius-sm); padding: 14px; transition: border-color 0.3s;
    }
    .tr-card:hover { border-color: var(--accent1); }
    .tr-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .tr-lang { display: flex; align-items: center; gap: 7px; }
    .tr-flag { font-size: 1.25rem; }
    .tr-name {
      font-size: 0.68rem; font-weight: 700;
      letter-spacing: 1px; text-transform: uppercase; color: var(--text3);
    }
    .tr-text {
      font-size: 1rem; color: var(--text);
      line-height: 1.65; min-height: 38px; word-break: break-word;
    }
    .tr-text[dir="rtl"] {
      font-size: 1.08rem;
      font-family: 'Noto Naskh Arabic', 'Segoe UI', 'Arial', sans-serif;
    }
    .tr-text.loading { color: var(--text3); font-style: italic; animation: blink 1.2s infinite; }
    .tr-text.err-text { color: var(--err-text); font-style: italic; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .tr-actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .tr-btn {
      padding: 6px 14px; border-radius: 20px; cursor: pointer;
      font-size: 0.78rem; font-weight: 500; transition: all 0.2s; border: none;
    }
    .play-btn {
      background: rgba(var(--accent-rgb), 0.15);
      border: 1px solid rgba(var(--accent-rgb), 0.35); color: var(--accent1);
    }
    .play-btn:hover { background: rgba(var(--accent-rgb), 0.28); }
    .play-btn.playing { background: rgba(var(--accent-rgb), 0.28); animation: button-pulse 1s infinite; }
    @keyframes button-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.65; } }
    .show-btn { background: transparent; border: 1px solid var(--border); color: var(--text2); }
    .show-btn:hover { background: var(--bg3); }
    .copy-btn { background: transparent; border: 1px solid var(--border); color: var(--text2); }
    .copy-btn:hover { background: var(--bg3); }
    .copy-btn.copied { color: var(--success); border-color: var(--success); }

    /* ===================== RESULTS HEADER ===================== */
    .results-head {
      display: flex; align-items: center;
      justify-content: space-between; margin-bottom: 14px;
    }
    .results-head .card-label { margin-bottom: 0; }
    .icon-btn {
      width: 30px; height: 30px; border-radius: 50%;
      border: 1px solid var(--border); background: transparent;
      color: var(--text2); font-size: 0.85rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; flex-shrink: 0;
    }
    .icon-btn:hover { background: var(--border); }

    /* ===================== –§–†–ê–ó–û–í–ù–ò–ö ===================== */
    .collapsible-head {
      display: flex; align-items: center; justify-content: space-between;
      cursor: pointer; user-select: none;
    }
    .collapsible-head .card-label { margin-bottom: 0; }
    .toggle-icon { font-size: 0.65rem; color: var(--text3); transition: transform 0.25s; }
    .toggle-icon.open { transform: rotate(180deg); }

    /* ===================== –ò–°–¢–û–†–ò–Ø ===================== */
    .history-body { margin-top: 12px; }
    .history-list { display: flex; flex-direction: column; gap: 6px; }
    .history-item {
      display: flex; align-items: center; gap: 8px;
      padding: 9px 12px; border: 1px solid var(--border);
      border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .history-item:hover { border-color: var(--accent1); background: rgba(var(--accent-rgb), 0.05); }
    .history-flag { font-size: 0.9rem; flex-shrink: 0; }
    .history-text {
      font-size: 0.85rem; color: var(--text); flex: 1;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .history-ts { font-size: 0.68rem; color: var(--text3); flex-shrink: 0; }
    .history-empty {
      text-align: center; color: var(--text3);
      font-size: 0.82rem; padding: 16px 0; font-style: italic;
    }
    .history-clear-btn {
      margin-top: 8px; width: 100%; padding: 8px;
      border: 1px solid var(--border); background: transparent;
      color: var(--text3); border-radius: var(--radius-sm);
      cursor: pointer; font-size: 0.72rem; transition: all 0.2s;
    }
    .history-clear-btn:hover { color: var(--danger); border-color: var(--danger); }

    /* ===================== FULLSCREEN ===================== */
    .fs-overlay {
      position: fixed; inset: 0; z-index: 9999;
      background: #000; display: none;
      flex-direction: column; align-items: center;
      justify-content: center; padding: 30px 24px;
    }
    .fs-lang { font-size: 1rem; color: rgba(255,255,255,0.4); margin-bottom: 28px; letter-spacing: 1px; }
    .fs-text {
      /* FIX: —É–≤–µ–ª–∏—á–µ–Ω –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
      font-size: clamp(2.4rem, 12vw, 4.5rem);
      color: #fff; text-align: center; line-height: 1.45;
      word-break: break-word;
      font-family: 'Noto Naskh Arabic', 'Segoe UI', 'Arial', sans-serif;
      max-width: 100%;
    }
    .fs-close {
      margin-top: 50px; padding: 13px 36px;
      border: 2px solid rgba(255,255,255,0.2); background: transparent;
      color: rgba(255,255,255,0.8); border-radius: 40px;
      font-size: 1rem; cursor: pointer; transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .fs-close:active, .fs-close:hover { background: rgba(255,255,255,0.12); }

    /* ===================== WORD COUNTER ===================== */
    .word-counter { font-size: 0.65rem; color: var(--text3); margin-top: 2px; transition: color 0.3s; }
    .word-counter.warn   { color: var(--warn-text); }
    .word-counter.danger { color: var(--danger); }

    /* ===================== –§–£–¢–ï–† ===================== */
    footer {
      text-align: center; color: var(--text3);
      font-size: 0.68rem; padding: 20px 16px 0; line-height: 1.8;
    }
  </style>
</head>
<body>

  <!-- –®–ê–ü–ö–ê -->
  <header>
    <div class="header-title">
      <h1>üåê –ì–æ–ª–æ—Å–æ–≤–æ–π –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫</h1>
      <span>–†—É—Å—Å–∫–∏–π ‚Üî –ê—Ä–∞–±—Å–∫–∏–π ¬∑ –¢—É—Ä–µ—Ü–∫–∏–π ¬∑ –ê–Ω–≥–ª–∏–π—Å–∫–∏–π</span>
    </div>
    <button class="theme-btn" id="themeBtn" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">‚òÄÔ∏è</button>
  </header>

  <div class="content">

    <!-- –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –±—Ä–∞—É–∑–µ—Ä -->
    <div class="msg warn" id="browserWarn">
      ‚ö†Ô∏è –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ <strong>Google Chrome</strong> –Ω–∞ Android. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ—Ç–∫—Ä—ã–ª–∏ –∏–º–µ–Ω–Ω–æ –≤ Chrome.
    </div>

    <!-- –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –Ω–µ—Ç TTS-–≥–æ–ª–æ—Å–∞ -->
    <div class="msg warn" id="ttsWarn" onclick="this.classList.remove('visible')" title="–ù–∞–∂–º–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è" style="cursor:pointer"></div>

    <!-- –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ -->
    <div class="msg warn" id="offlineWarn">
      üìµ –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞. –ü–µ—Ä–µ–≤–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ë—ã—Å—Ç—Ä—ã–µ —Ñ—Ä–∞–∑—ã —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.
    </div>

    <!-- –í–ö–õ–ê–î–ö–ò -->
    <div class="tabs">
      <button class="tab active" id="tab-ru" onclick="setMode('ru')">
        üá∑üá∫ –Ø –≥–æ–≤–æ—Ä—é<br>–ø–æ-—Ä—É—Å—Å–∫–∏
      </button>
      <button class="tab" id="tab-foreign" onclick="setMode('foreign')">
        üåç –ú–Ω–µ –≥–æ–≤–æ—Ä—è—Ç<br>–Ω–∞ –¥—Ä—É–≥–æ–º —è–∑—ã–∫–µ
      </button>
    </div>

    <!-- –ë–õ–û–ö –í–í–û–î–ê -->
    <div class="card" id="inputCard">

      <!-- –í—ã–±–æ—Ä —è–∑—ã–∫–∞ (–æ–±–∞ —Ä–µ–∂–∏–º–∞) -->
      <div id="langPillsWrap">
        <div class="card-label" id="langPillsLabel">–ù–∞ –∫–∞–∫–æ–π —è–∑—ã–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å:</div>
        <div class="lang-pills">
          <button class="lang-pill active" data-lang="ar-SA" data-code="ar" onclick="selectForeignLang(this)">üá∏üá¶ –ê—Ä–∞–±—Å–∫–∏–π</button>
          <button class="lang-pill" data-lang="tr-TR" data-code="tr" onclick="selectForeignLang(this)">üáπüá∑ –¢—É—Ä–µ—Ü–∫–∏–π</button>
          <button class="lang-pill" data-lang="en-US" data-code="en" onclick="selectForeignLang(this)">üá¨üáß –ê–Ω–≥–ª–∏–π—Å–∫–∏–π</button>
        </div>
        <div style="height:16px"></div>
      </div>

      <!-- –ú–∏–∫—Ä–æ—Ñ–æ–Ω -->
      <div class="record-wrap">
        <button class="mic-btn" id="micBtn" onclick="toggleRecording()">üé§</button>
        <div class="record-hint" id="recordHint">–ù–∞–∂–º–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏</div>
      </div>

      <!-- –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ -->
      <div class="text-input-row">
        <input
          class="text-input" id="textInput" type="text"
          placeholder="–∏–ª–∏ –≤–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é..."
          onkeydown="if(event.key==='Enter') sendText()"
        />
        <button class="send-btn" onclick="sendText()" title="–ü–µ—Ä–µ–≤–µ—Å—Ç–∏">‚úàÔ∏è</button>
      </div>

      <!-- TTS —Å–∫–æ—Ä–æ—Å—Ç—å -->
      <div class="controls-row">
        <span class="controls-label">–°–∫–æ—Ä–æ—Å—Ç—å TTS:</span>
        <button class="speed-btn" data-rate="0.65" onclick="setTtsRate(this)" title="–ú–µ–¥–ª–µ–Ω–Ω–æ">üê¢</button>
        <button class="speed-btn" data-rate="0.88" onclick="setTtsRate(this)" title="–ù–æ—Ä–º–∞–ª—å–Ω–æ">‚ñ∂</button>
        <button class="speed-btn" data-rate="1.1"  onclick="setTtsRate(this)" title="–ë—ã—Å—Ç—Ä–æ">üêá</button>
      </div>

      <!-- –û—à–∏–±–∫–∞ -->
      <div class="msg err" id="errorMsg" style="margin-top:12px"></div>
    </div>


    <!-- –†–ê–°–ü–û–ó–ù–ê–ù–û -->
    <div class="card" id="recognizedCard" style="display:none">
      <div class="card-label">–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ</div>
      <div class="recognized-box" id="recognizedBox"></div>
    </div>

    <!-- –ü–ï–†–ï–í–û–î–´ -->
    <div class="card" id="resultsCard" style="display:none">
      <div class="results-head">
        <span class="card-label">–ü–µ—Ä–µ–≤–æ–¥—ã</span>
        <button class="icon-btn" id="repeatBtn" onclick="repeatTTS()" style="display:none" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –≤—Å—ë">üîÅ</button>
      </div>
      <div class="translations" id="translationsBox"></div>
    </div>

    <!-- –ò–°–¢–û–†–ò–Ø -->
    <div class="card" id="historyCard">
      <div class="collapsible-head" onclick="toggleHistory()">
        <span class="card-label">üïê –ò—Å—Ç–æ—Ä–∏—è</span>
        <span class="toggle-icon" id="histToggleIcon">‚ñº</span>
      </div>
      <div class="history-body" id="historyBody" style="display:none">
        <div class="history-list" id="historyList"></div>
      </div>
    </div>

  </div>

  <!-- –§–£–¢–ï–† -->
  <footer>
    –ü–µ—Ä–µ–≤–æ–¥: MyMemory API ¬∑ –ì–æ–ª–æ—Å: –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π TTS ¬∑ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ: Web Speech API<br>
    <div id="wordCounter" class="word-counter"></div>
  </footer>

  <!-- FULLSCREEN OVERLAY -->
  <div id="fsOverlay" class="fs-overlay">
    <div class="fs-lang" id="fsLang"></div>
    <div class="fs-text" id="fsText"></div>
    <button class="fs-close" onclick="closeFullscreen()">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
  </div>

<script>
/* ============================================================
   –ö–û–ù–§–ò–ì
============================================================ */
const MYMEMORY_EMAIL = 'timtim044@mail.ru';
const HISTORY_KEY    = 'lv_history';
const WORDS_KEY      = 'lv_words';

/* ============================================================
   –°–û–°–¢–û–Ø–ù–ò–ï
============================================================ */
let mode             = 'ru';
let foreignLang      = 'ar-SA';
let foreignCode      = 'ar';
let isRecording      = false;
let recognition      = null;
let ttsQueue         = [];
let ttsPlaying       = false;
let ttsRate          = 0.88;
let lastSuccessTexts = [];
let wakeLock         = null;
let histOpen         = false;
let translationSeq   = 0;   // –∑–∞—â–∏—Ç–∞ –æ—Ç –≥–æ–Ω–∫–∏: —Å–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞ –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ–≤–æ–¥–∞

/* ============================================================
   –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –Ø–ó–´–ö–û–í
============================================================ */
const TARGETS = {
  ru: [
    { code: 'ar', speech: 'ar-SA', name: '–ê—Ä–∞–±—Å–∫–∏–π',   flag: 'üá∏üá¶', rtl: true  },
    { code: 'tr', speech: 'tr-TR', name: '–¢—É—Ä–µ—Ü–∫–∏–π',   flag: 'üáπüá∑', rtl: false },
    { code: 'en', speech: 'en-US', name: '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π', flag: 'üá¨üáß', rtl: false },
  ],
  foreign: [
    { code: 'ru', speech: 'ru-RU', name: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫', rtl: false },
  ],
};
const ALL_LANGS = [...TARGETS.ru, ...TARGETS.foreign];


/* ============================================================
   –¢–ï–ú–ê
============================================================ */
(function initTheme() {
  const saved = localStorage.getItem('theme')
    || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
  setTheme(saved, false);
})();

function setTheme(theme, save = true) {
  document.documentElement.setAttribute('data-theme', theme === 'light' ? 'light' : 'dark');
  document.getElementById('themeBtn').textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
  const meta = document.getElementById('themeColorMeta');
  if (meta) meta.content = theme === 'light' ? '#0984e3' : '#667eea';
  if (save) localStorage.setItem('theme', theme);
}
document.getElementById('themeBtn').addEventListener('click', () => {
  const current = localStorage.getItem('theme') || 'dark';
  setTheme(current === 'dark' ? 'light' : 'dark');
});

/* ============================================================
   –†–ï–ñ–ò–ú
============================================================ */
function setMode(m) {
  mode = m;
  document.getElementById('tab-ru').classList.toggle('active', m === 'ru');
  document.getElementById('tab-foreign').classList.toggle('active', m === 'foreign');
  document.getElementById('langPillsLabel').textContent =
    m === 'ru' ? '–ù–∞ –∫–∞–∫–æ–π —è–∑—ã–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å:' : '–Ø–∑—ã–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:';
  resetUI();
}
function selectForeignLang(btn) {
  document.querySelectorAll('.lang-pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  foreignLang = btn.dataset.lang;
  foreignCode = btn.dataset.code;
}

/* ============================================================
   –°–ë–†–û–° UI
============================================================ */
function resetUI() {
  translationSeq++;                                               // –æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–µ–≤–æ–¥
  stopTTS();
  document.getElementById('recognizedCard').style.display = 'none';
  document.getElementById('resultsCard').style.display    = 'none';
  document.getElementById('recognizedBox').textContent    = '';
  document.getElementById('translationsBox').innerHTML    = '';
  document.getElementById('repeatBtn').style.display      = 'none';
  lastSuccessTexts = [];
  hideError();
}

/* ============================================================
   –û–®–ò–ë–ö–ò
============================================================ */
function showError(msg) {
  const el = document.getElementById('errorMsg');
  el.textContent = msg; el.classList.add('visible');
}
function hideError() {
  document.getElementById('errorMsg').classList.remove('visible');
}

/* ============================================================
   –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –†–ï–ß–ò
============================================================ */
function getInputLang() { return mode === 'ru' ? 'ru-RU' : foreignLang; }
function getInputCode() { return mode === 'ru' ? 'ru'    : foreignCode; }

function toggleRecording() {
  if (document.getElementById('micBtn').classList.contains('busy')) return;
  if (isRecording) { recognition && recognition.stop(); }
  else { startRecording(); }
}

function startRecording() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    showError('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ Google Chrome.');
    return;
  }
  hideError(); resetUI();
  recognition = new SR();
  recognition.lang            = getInputLang();
  recognition.continuous      = false;
  recognition.interimResults  = true;
  recognition.maxAlternatives = 1;

  recognition.onstart = () => {
    isRecording = true;
    navigator.vibrate && navigator.vibrate(50);
    requestWakeLock();
    document.getElementById('micBtn').classList.add('recording');
    document.getElementById('micBtn').textContent = '‚èπ';
    document.getElementById('recordHint').textContent = '–°–ª—É—à–∞—é... –ì–æ–≤–æ—Ä–∏—Ç–µ';
    document.getElementById('recordHint').classList.add('live');
    document.getElementById('recognizedCard').style.display = 'block';
    document.getElementById('recognizedBox').textContent = '...';
    document.getElementById('recognizedBox').classList.add('empty');
  };

  recognition.onresult = (e) => {
    const last       = e.results[e.results.length - 1];
    const transcript = last[0].transcript.trim();
    const box        = document.getElementById('recognizedBox');
    box.textContent  = transcript;
    box.classList.remove('empty');
    if (last.isFinal && transcript) doTranslate(transcript, getInputCode());
  };

  recognition.onerror = (e) => {
    stopRecordingUI();
    const msgs = {
      'not-allowed': '–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.',
      'no-speech':   '–ù–∏—á–µ–≥–æ –Ω–µ —É—Å–ª—ã—à–∞–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.',
      'network':     '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.',
      'aborted':     '',
    };
    const msg = msgs[e.error] ?? ('–û—à–∏–±–∫–∞: ' + e.error);
    if (msg) showError(msg);
  };

  recognition.onend = () => { stopRecordingUI(); };

  try { recognition.start(); }
  catch(err) { showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω: ' + err.message); }
}

function stopRecordingUI() {
  if (!isRecording) return;   // guard: onend –≤—Å–µ–≥–¥–∞ —Å–ª–µ–¥—É–µ—Ç –∑–∞ onerror
  isRecording = false;
  navigator.vibrate && navigator.vibrate([30, 50, 30]);
  document.getElementById('micBtn').classList.remove('recording');
  document.getElementById('micBtn').textContent = 'üé§';
  document.getElementById('recordHint').textContent = '–ù–∞–∂–º–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏';
  document.getElementById('recordHint').classList.remove('live');
}

/* ============================================================
   –¢–ï–ö–°–¢–û–í–´–ô –í–í–û–î
============================================================ */
function sendText() {
  if (document.getElementById('micBtn').classList.contains('busy')) return;
  const val = document.getElementById('textInput').value.trim();
  if (!val) return;
  hideError(); resetUI();
  document.getElementById('recognizedCard').style.display = 'block';
  const box = document.getElementById('recognizedBox');
  box.textContent = val; box.classList.remove('empty');
  document.getElementById('textInput').value = '';
  doTranslate(val, getInputCode(), true);   // fromText=true ‚Üí –≤–µ—Ä–Ω—ë–º —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –ø—Ä–æ–≤–∞–ª–∏—Ç—Å—è
}

/* ============================================================
   –ü–ï–†–ï–í–û–î ‚Äî —á–µ—Ä–µ–∑ API
============================================================ */
async function translateText(text, from, to) {
  const emailParam = MYMEMORY_EMAIL ? `&de=${encodeURIComponent(MYMEMORY_EMAIL)}` : '';
  const url  = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${from}|${to}${emailParam}`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  const data = await resp.json();
  if (data.responseStatus !== 200 && data.responseStatus !== '200') {
    const details = String(data.responseDetails || '').toUpperCase();
    if (details.includes('DAILY LIMIT') || details.includes('ALLOWANCE') ||
        data.responseStatus == 429 || data.responseStatus == 403) {
      throw new Error('QUOTA_EXCEEDED');
    }
    throw new Error(data.responseDetails || '–û—à–∏–±–∫–∞ API');
  }
  const translated = data.responseData.translatedText || '';
  // –ò–Ω–æ–≥–¥–∞ MyMemory –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200, –Ω–æ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –ª–∏–º–∏—Ç–µ
  if (translated.toUpperCase().includes('MYMEMORY WARNING')) {
    throw new Error('QUOTA_EXCEEDED');
  }
  // –î–ª—è –ª–∞—Ç–∏–Ω—Å–∫–∏—Ö —è–∑—ã–∫–æ–≤ (en, tr) –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏–≤—É—é –∫–æ–¥–∏—Ä–æ–≤–∫—É:
  // MyMemory –∏–Ω–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∏—Ä–∏–ª–ª–∏—Ü—É –≤ Windows-1251, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ –º—É—Å–æ—Ä
  if (to === 'en') {
    const nonAscii = (translated.match(/[^\x00-\x7F]/g) || []).length;
    if (nonAscii > translated.length * 0.1) throw new Error('–û—à–∏–±–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ API');
  }
  return translated;
}

async function doTranslate(text, fromCode, fromText = false) {
  const mySeq  = ++translationSeq;              // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
  // –í —Ä–µ–∂–∏–º–µ "—è –≥–æ–≤–æ—Ä—é –ø–æ-—Ä—É—Å—Å–∫–∏" ‚Äî —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫
  const targets = mode === 'ru'
    ? TARGETS.ru.filter(t => t.code === foreignCode)
    : TARGETS.foreign;
  const box = document.getElementById('translationsBox');
  box.innerHTML = '';
  document.getElementById('resultsCard').style.display = 'block';
  document.getElementById('micBtn').classList.add('busy');
  document.getElementById('repeatBtn').style.display = 'none';

  targets.forEach(lang => {
    box.insertAdjacentHTML('beforeend', `
      <div class="tr-card" id="card-${lang.code}">
        <div class="tr-header">
          <div class="tr-lang">
            <span class="tr-flag">${lang.flag}</span>
            <span class="tr-name">${lang.name}</span>
          </div>
        </div>
        <div class="tr-text loading" id="text-${lang.code}" dir="${lang.rtl ? 'rtl' : 'ltr'}">–ü–µ—Ä–µ–≤–æ–¥–∏–º...</div>
        <div class="tr-actions" id="actions-${lang.code}" style="display:none">
          <button class="tr-btn play-btn" id="play-${lang.code}"
            onclick="speakOne('${lang.code}', '${lang.speech}')">‚ñ∂ –û–∑–≤—É—á–∏—Ç—å</button>
          <button class="tr-btn show-btn"
            onclick="showFullscreen('${lang.code}')">üëÅ –ü–æ–∫–∞–∑–∞—Ç—å</button>
          <button class="tr-btn copy-btn" id="copy-${lang.code}"
            onclick="copyOne('${lang.code}')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>
    `);
  });

  const results = await Promise.allSettled(
    targets.map(lang => translateText(text, fromCode, lang.code).then(t => ({ lang, t })))
  );

  // –°–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ (–¥–∞–∂–µ –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É—Å—Ç–∞—Ä–µ–ª)
  document.getElementById('micBtn').classList.remove('busy');

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–µ–Ω–∏–ª —Ä–µ–∂–∏–º –ø–æ–∫–∞ —à—ë–ª –∑–∞–ø—Ä–æ—Å ‚Äî –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  if (mySeq !== translationSeq) return;

  const successTexts = [];
  let   quotaError   = false;
  results.forEach((res, i) => {
    if (res.status === 'fulfilled') {
      const { lang, t } = res.value;
      const el = document.getElementById(`text-${lang.code}`);
      el.textContent = t; el.classList.remove('loading');
      el.dataset.translated = t; el.dataset.speech = lang.speech;
      document.getElementById(`actions-${lang.code}`).style.display = 'flex';
      successTexts.push({ code: lang.code, speech: lang.speech, text: t });
    } else {
      const code = targets[i].code;
      const el   = document.getElementById(`text-${code}`);
      el.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–≤–µ—Å—Ç–∏';
      el.classList.remove('loading'); el.classList.add('err-text');
      if (res.reason?.message === 'QUOTA_EXCEEDED') quotaError = true;
    }
  });

  if (quotaError) {
    showError('–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç API –∏—Å—á–µ—Ä–ø–∞–Ω (10 000 —Å–ª–æ–≤). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≤—Ç—Ä–∞. –ë—ã—Å—Ç—Ä—ã–µ —Ñ—Ä–∞–∑—ã —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.');
  }

  if (successTexts.length) {
    lastSuccessTexts = successTexts;
    document.getElementById('repeatBtn').style.display = 'flex';
    saveHistory(text, fromCode, successTexts);
    trackApiWords(text, targets.length);
    autoPlay(successTexts);
    // –°–∫—Ä–æ–ª–ª –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º ‚Äî –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è DOM
    setTimeout(() => {
      document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 150);
  } else if (fromText) {
    // –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ –µ—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è
    const inp = document.getElementById('textInput');
    if (!inp.value) inp.value = text;
  }
}

/* ============================================================
   –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –°–û–•–†–ê–ù–Å–ù–ù–´–• –ü–ï–†–ï–í–û–î–û–í (–±–µ–∑ API)
   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: —Ñ—Ä–∞–∑–æ–≤–Ω–∏–∫ + –∏—Å—Ç–æ—Ä–∏—è
============================================================ */
function displaySavedTranslations(originalText, fromCode, modeKey, savedTranslations) {
  const targets = TARGETS[modeKey] || TARGETS['ru'];
  const box = document.getElementById('translationsBox');
  box.innerHTML = '';
  document.getElementById('recognizedCard').style.display = 'block';
  document.getElementById('resultsCard').style.display    = 'block';

  const rbox = document.getElementById('recognizedBox');
  rbox.textContent = originalText;
  rbox.classList.remove('empty');

  const successTexts = [];
  targets.forEach(lang => {
    const saved = savedTranslations.find(t => t.code === lang.code);
    if (!saved) return;

    box.insertAdjacentHTML('beforeend', `
      <div class="tr-card" id="card-${lang.code}">
        <div class="tr-header">
          <div class="tr-lang">
            <span class="tr-flag">${lang.flag}</span>
            <span class="tr-name">${lang.name}</span>
          </div>
        </div>
        <div class="tr-text" id="text-${lang.code}" dir="${lang.rtl ? 'rtl' : 'ltr'}"></div>
        <div class="tr-actions" id="actions-${lang.code}" style="display:flex">
          <button class="tr-btn play-btn" id="play-${lang.code}"
            onclick="speakOne('${lang.code}', '${lang.speech}')">‚ñ∂ –û–∑–≤—É—á–∏—Ç—å</button>
          <button class="tr-btn show-btn"
            onclick="showFullscreen('${lang.code}')">üëÅ –ü–æ–∫–∞–∑–∞—Ç—å</button>
          <button class="tr-btn copy-btn" id="copy-${lang.code}"
            onclick="copyOne('${lang.code}')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>
    `);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ JS (–±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–µ—Ç XSS)
    const el = document.getElementById(`text-${lang.code}`);
    el.textContent        = saved.text;
    el.dataset.translated = saved.text;
    el.dataset.speech     = lang.speech;

    successTexts.push({ code: lang.code, speech: lang.speech, text: saved.text });
  });

  lastSuccessTexts = successTexts;
  document.getElementById('repeatBtn').style.display = successTexts.length ? 'flex' : 'none';
  if (successTexts.length) {
    setTimeout(() => {
      document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
  }
  return successTexts;
}

/* ============================================================
   TTS
============================================================ */
function stopTTS() {
  window.speechSynthesis.cancel();
  ttsQueue = []; ttsPlaying = false;
  document.querySelectorAll('.play-btn').forEach(b => b.classList.remove('playing'));
}
function autoPlay(list) { stopTTS(); ttsQueue = [...list]; playNext(); }
function repeatTTS()    { if (lastSuccessTexts.length) autoPlay([...lastSuccessTexts]); }

function playNext() {
  if (!ttsQueue.length) { ttsPlaying = false; return; }
  ttsPlaying = true;
  const item    = ttsQueue.shift();
  const playBtn = document.getElementById(`play-${item.code}`);
  if (playBtn) playBtn.classList.add('playing');

  const u = new SpeechSynthesisUtterance(item.text);
  u.lang  = item.speech; u.rate = ttsRate; u.pitch = 1;

  const voices = window.speechSynthesis.getVoices();
  const prefix = item.speech.split('-')[0];
  const voice  = voices.find(v => v.lang === item.speech)
              || voices.find(v => v.lang.startsWith(prefix));
  if (voice) u.voice = voice;

  const resumeTimer = setInterval(() => {
    if (window.speechSynthesis.paused) window.speechSynthesis.resume();
  }, 500);

  const words    = item.text.split(/\s+/).length;
  const timeout  = Math.max(words * 600, 5000) + 2000;
  const watchdog = setTimeout(() => {
    clearInterval(resumeTimer);
    window.speechSynthesis.cancel();
    if (playBtn) playBtn.classList.remove('playing');
    setTimeout(playNext, 300);
  }, timeout);

  const cleanup = () => { clearInterval(resumeTimer); clearTimeout(watchdog); if (playBtn) playBtn.classList.remove('playing'); };
  u.onend  = () => { cleanup(); setTimeout(playNext, 400); };
  u.onerror = () => { cleanup(); setTimeout(playNext, 200); };
  window.speechSynthesis.speak(u);
}

function speakOne(code, speechCode) {
  stopTTS();
  const el   = document.getElementById(`text-${code}`);
  const text = el.dataset.translated || el.textContent;
  if (!text || el.classList.contains('loading') || el.classList.contains('err-text')) return;
  autoPlay([{ code, speech: speechCode, text }]);
}

function copyOne(code) {
  const el   = document.getElementById(`text-${code}`);
  const text = el.dataset.translated || el.textContent;
  if (!text) return;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById(`copy-${code}`);
    btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'; btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; btn.classList.remove('copied'); }, 2000);
  }).catch(() => {
    showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ‚Äî —É–¥–µ—Ä–∂–∏ —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä—É—á–Ω—É—é.');
    setTimeout(hideError, 3000);
  });
}

/* ============================================================
   TTS –°–ö–û–†–û–°–¢–¨
============================================================ */
function setTtsRate(btn) {
  ttsRate = parseFloat(btn.dataset.rate);
  localStorage.setItem('ttsRate', ttsRate);
  document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

/* ============================================================
   FULLSCREEN ‚Äî —Ä–µ–∂–∏–º "–ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É"
============================================================ */
function showFullscreen(code) {
  const el = document.getElementById(`text-${code}`);
  if (!el || el.classList.contains('loading') || el.classList.contains('err-text')) return;
  const text   = el.dataset.translated || el.textContent;
  const dir    = el.getAttribute('dir') || 'ltr';
  const speech = el.dataset.speech || '';
  const lang   = ALL_LANGS.find(l => l.code === code);

  document.getElementById('fsText').textContent = text;
  document.getElementById('fsText').setAttribute('dir', dir);
  document.getElementById('fsLang').textContent = lang ? `${lang.flag} ${lang.name}` : '';
  document.getElementById('fsOverlay').style.display = 'flex';

  document.documentElement.requestFullscreen && document.documentElement.requestFullscreen().catch(() => {});
  if (speech) speakOne(code, speech);
}

function closeFullscreen() {
  document.getElementById('fsOverlay').style.display = 'none';
  if (document.fullscreenElement) document.exitFullscreen().catch(() => {});
  stopTTS();
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeFullscreen(); });
// Android: —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ fullscreen –±–µ–∑ Escape
document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement) {
    const ov = document.getElementById('fsOverlay');
    if (ov && ov.style.display !== 'none') { ov.style.display = 'none'; stopTTS(); }
  }
});

/* ============================================================
   –ò–°–¢–û–†–ò–Ø ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–µ—Ä–µ–≤–æ–¥—ã, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –ë–ï–ó API
============================================================ */
function getHistory() {
  try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; }
  catch { return []; }
}

function saveHistory(text, fromCode, successTexts) {
  const history = getHistory();
  if (history.length && history[0].text === text) return;
  history.unshift({
    id: Date.now(), text, fromCode, mode,
    ts: new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' }),
    translations: successTexts.map(t => ({ code: t.code, speech: t.speech, text: t.text })),
  });
  if (history.length > 15) history.pop();
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
  if (histOpen) renderHistory();
}

function toggleHistory() {
  histOpen = !histOpen;
  document.getElementById('historyBody').style.display = histOpen ? 'block' : 'none';
  document.getElementById('histToggleIcon').classList.toggle('open', histOpen);
  if (histOpen) renderHistory();
}

function renderHistory() {
  const list    = document.getElementById('historyList');
  const history = getHistory();
  list.innerHTML = '';

  if (!history.length) {
    const empty = document.createElement('div');
    empty.className = 'history-empty'; empty.textContent = '–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞';
    list.appendChild(empty); return;
  }

  history.forEach(h => {
    const fromLang = ALL_LANGS.find(l => l.code === h.fromCode);
    const item = document.createElement('div');
    item.className = 'history-item';

    const flag = document.createElement('span');
    flag.className   = 'history-flag';
    flag.textContent = fromLang ? fromLang.flag : 'üåê';

    const textEl = document.createElement('span');
    textEl.className   = 'history-text';
    textEl.textContent = h.text;

    const tsEl = document.createElement('span');
    tsEl.className   = 'history-ts';
    tsEl.textContent = h.ts;

    item.appendChild(flag); item.appendChild(textEl); item.appendChild(tsEl);
    item.onclick = () => replayFromHistory(h);
    list.appendChild(item);
  });

  const clearBtn = document.createElement('button');
  clearBtn.className   = 'history-clear-btn';
  clearBtn.textContent = 'üóë –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é';
  clearBtn.onclick     = () => { localStorage.removeItem(HISTORY_KEY); renderHistory(); };
  list.appendChild(clearBtn);
}

function replayFromHistory(h) {
  const targetMode = h.mode || 'ru';
  if (targetMode !== mode) {
    mode = targetMode;
    document.getElementById('tab-ru').classList.toggle('active', mode === 'ru');
    document.getElementById('tab-foreign').classList.toggle('active', mode === 'foreign');
    document.getElementById('langPillsWrap').style.display  = mode === 'foreign' ? 'block' : 'none';
    document.getElementById('phrasebookCard').style.display = mode === 'ru'      ? 'block' : 'none';
  }

  hideError(); resetUI();

  if (h.translations && h.translations.length) {
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ‚Äî API –Ω–µ –Ω—É–∂–µ–Ω
    const successTexts = displaySavedTranslations(h.text, h.fromCode, targetMode, h.translations);
    if (successTexts.length) autoPlay(successTexts);
  } else {
    // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤ ‚Äî –ø–µ—Ä–µ–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º
    document.getElementById('recognizedCard').style.display = 'block';
    const rbox = document.getElementById('recognizedBox');
    rbox.textContent = h.text; rbox.classList.remove('empty');
    doTranslate(h.text, h.fromCode);
  }
}

/* ============================================================
   –°–ß–Å–¢–ß–ò–ö –°–õ–û–í API
============================================================ */
function trackApiWords(text, numTargets) {
  const wordCount = text.trim().split(/\s+/).filter(Boolean).length;
  const today = new Date().toDateString();
  let stored;
  try { stored = JSON.parse(localStorage.getItem(WORDS_KEY) || '{}'); }
  catch { stored = {}; }
  const prev     = stored.date === today ? (stored.count || 0) : 0;
  const newCount = prev + wordCount * numTargets;
  localStorage.setItem(WORDS_KEY, JSON.stringify({ date: today, count: newCount }));
  renderWordCounter(newCount);
}

function renderWordCounter(count) {
  const el    = document.getElementById('wordCounter');
  if (!el) return;
  const limit = MYMEMORY_EMAIL ? 10000 : 1000;
  const pct   = count / limit;
  el.textContent = `–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è: ${count.toLocaleString('ru')} / ${limit.toLocaleString('ru')} —Å–ª–æ–≤`;
  el.className   = 'word-counter' + (pct >= 0.9 ? ' danger' : pct >= 0.75 ? ' warn' : '');
}

/* ============================================================
   –ü–†–û–í–ï–†–ö–ê TTS-–ì–û–õ–û–°–û–í
============================================================ */
function checkTTSVoices() {
  const voices = window.speechSynthesis.getVoices();
  if (!voices.length) return; // –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã

  const missing = [];
  if (!voices.some(v => v.lang.startsWith('ar'))) missing.push('–ê—Ä–∞–±—Å–∫–∏–π');
  if (!voices.some(v => v.lang.startsWith('tr'))) missing.push('–¢—É—Ä–µ—Ü–∫–∏–π');

  const el = document.getElementById('ttsWarn');
  if (!el) return;
  if (missing.length) {
    el.textContent = `üîá –ù–µ –Ω–∞–π–¥–µ–Ω—ã TTS-–≥–æ–ª–æ—Å–∞: ${missing.join(', ')}. –≠—Ç–∏ —è–∑—ã–∫–∏ –Ω–µ –±—É–¥—É—Ç –æ–∑–≤—É—á–µ–Ω—ã. –£—Å—Ç–∞–Ω–æ–≤–∏ —è–∑—ã–∫–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã: Android ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å ‚Üí –°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏.`;
    el.classList.add('visible');
  } else {
    el.classList.remove('visible');
  }
}

/* ============================================================
   –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø –°–ï–¢–ò
============================================================ */
function updateOnlineStatus() {
  const offline = !navigator.onLine;
  document.getElementById('offlineWarn').classList.toggle('visible', offline);
}
window.addEventListener('online',  updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

/* ============================================================
   WAKE LOCK ‚Äî —ç–∫—Ä–∞–Ω –Ω–µ –≥–∞—Å–Ω–µ—Ç
============================================================ */
async function requestWakeLock() {
  if (!('wakeLock' in navigator)) return;
  try {
    wakeLock = await navigator.wakeLock.request('screen');
    wakeLock.addEventListener('release', () => { wakeLock = null; });
  } catch(e) {}
}
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') requestWakeLock();
});
requestWakeLock();

/* ============================================================
   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ì–û–õ–û–°–û–í
============================================================ */
if (window.speechSynthesis) {
  window.speechSynthesis.onvoiceschanged = () => {
    window.speechSynthesis.getVoices();
    checkTTSVoices();
  };
  window.speechSynthesis.getVoices();
  // –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç –≥–æ–ª–æ—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–∞–∑—É
  setTimeout(checkTTSVoices, 500);
}

/* ============================================================
   –ü–†–û–í–ï–†–ö–ê –ë–†–ê–£–ó–ï–†–ê
============================================================ */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SR) {
  document.getElementById('browserWarn').classList.add('visible');
}

/* ============================================================
   SERVICE WORKER (PWA)
============================================================ */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  });
}

/* ============================================================
   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø UI
============================================================ */
(function init() {
  // TTS —Å–∫–æ—Ä–æ—Å—Ç—å
  const savedRate = parseFloat(localStorage.getItem('ttsRate') || '0.88');
  ttsRate = savedRate;
  document.querySelectorAll('.speed-btn').forEach(btn => {
    btn.classList.toggle('active', parseFloat(btn.dataset.rate) === savedRate);
  });

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∏
  updateOnlineStatus();

  // –°—á—ë—Ç—á–∏–∫ —Å–ª–æ–≤
  const today = new Date().toDateString();
  try {
    const stored = JSON.parse(localStorage.getItem(WORDS_KEY) || '{}');
    renderWordCounter(stored.date === today ? (stored.count || 0) : 0);
  } catch { renderWordCounter(0); }
})();
</script>
</body>
</html>
